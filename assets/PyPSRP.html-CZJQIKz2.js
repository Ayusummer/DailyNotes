import{_ as e}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as o,o as c,c as l,a as n,d as s,b as t,e as p}from"./app-DxMJFouC.js";const u={},i=p('<h1 id="pypsrp" tabindex="-1"><a class="header-anchor" href="#pypsrp"><span>PYPSRP</span></a></h1><ul><li><a href="#pypsrp">PYPSRP</a><ul><li><a href="#runspace-pool-and-runspaces-%E8%BF%90%E8%A1%8C%E7%A9%BA%E9%97%B4%E6%B1%A0%E5%92%8C%E8%BF%90%E8%A1%8C%E7%A9%BA%E9%97%B4">Runspace Pool and Runspaces 运行空间池和运行空间</a></li><li><a href="#pileline-%E7%AE%A1%E9%81%93">Pileline 管道</a></li><li><a href="#statements-%E8%AF%AD%E5%8F%A5">Statements 语句</a></li><li><a href="#commands-%E5%91%BD%E4%BB%A4">Commands 命令</a></li><li><a href="#streams%E6%B5%81">Streams(流)</a></li><li><a href="#objects%E5%AF%B9%E8%B1%A1">Objects(对象)</a></li><li><a href="#process-flow">Process Flow</a></li><li><a href="#message-structure-%E6%B6%88%E6%81%AF%E7%BB%93%E6%9E%84">Message Structure 消息结构</a></li><li><a href="#wsman">WSMan</a></li><li><a href="#%E5%AE%89%E8%A3%85-pypsrp">安装 pypsrp</a></li><li><a href="#%E7%A4%BA%E4%BE%8B">示例</a></li><li><a href="#winrs-%E7%A4%BA%E4%BE%8B">WInRS 示例</a></li><li><a href="#interop-with-secure-strings">Interop with Secure Strings</a></li></ul></li></ul><hr>',3),r={href:"https://www.bloggingforlogging.com/sample-page/",target:"_blank",rel:"noopener noreferrer"},k=n("code",null,"PowerShell 2-5.x",-1),d=n("p",null,"在介绍 PYPSRP 前需要了解一些 PSRP 中的概念",-1),m={href:"https://www.bloggingforlogging.com/2018/08/14/powershell-remoting-on-python/",target:"_blank",rel:"noopener noreferrer"},g=p(`<hr><h2 id="runspace-pool-and-runspaces-运行空间池和运行空间" tabindex="-1"><a class="header-anchor" href="#runspace-pool-and-runspaces-运行空间池和运行空间"><span>Runspace Pool and Runspaces 运行空间池和运行空间</span></a></h2><p>Runspaces 是指现有 PowerShell 进程上的一个新线程, 可以在某个事件点运行单个 &quot;Pipeline&quot;</p><p>Runspace Pool 是 Runspace 的集合(collection)/池(pool) , 他可以高效地处理多个 Runspace 的执行</p><hr><h2 id="pileline-管道" tabindex="-1"><a class="header-anchor" href="#pileline-管道"><span>Pileline 管道</span></a></h2><p>在 PSRP 中, Pipeline 是在 Runspace 上执行 &quot;Statements(语句)&quot; 的有序集合</p><p>Runspace 和 Pipeline 存在一一对应的关系, 这意味着每个 Runspace 只能执行一个 Pipeline</p><hr><h2 id="statements-语句" tabindex="-1"><a class="header-anchor" href="#statements-语句"><span>Statements 语句</span></a></h2><p>statement 是在 Pipeline 上运行的 Commands/scripts 的有序集合</p><p>一条语句很容易被视为一个工作单元, 并且通常在 powershell 中表示为一行, 例如:</p><div class="language-powershell line-numbers-mode" data-ext="powershell" data-title="powershell"><pre class="language-powershell"><code><span class="token comment"># 2 statement</span>
<span class="token variable">$service</span> = <span class="token function">Get-Service</span> <span class="token operator">-</span>Name winrm
<span class="token variable">$service</span><span class="token punctuation">.</span>Status

<span class="token comment"># same 2 statements in the 1 line</span>
<span class="token variable">$service</span> = <span class="token function">Get-Service</span> <span class="token operator">-</span>Name winrm<span class="token punctuation">;</span> <span class="token variable">$service</span><span class="token punctuation">.</span>Status
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="commands-命令" tabindex="-1"><a class="header-anchor" href="#commands-命令"><span>Commands 命令</span></a></h2><p>Command 是通过 pipe 连接在一起的 cmdlet 或 scripts 的有序集合</p><blockquote><p>例如:</p><div class="language-powershell line-numbers-mode" data-ext="powershell" data-title="powershell"><pre class="language-powershell"><code><span class="token function">Get-Process</span> <span class="token punctuation">|</span> <span class="token function">Where-Object</span> <span class="token punctuation">{</span><span class="token variable">$_</span><span class="token punctuation">.</span>Name <span class="token operator">-eq</span> <span class="token string">&quot;explorer&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">|</span> <span class="token function">Stop-Process</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>pipe 用于将一个命令的输出传给另一个命令的输入, 形成命令链, 这样就可以用于将多个命令连接起来从而实现更复杂的任务</p><p>上述语句中的 <code>|</code> 就是 pipe, <code>Get-Process</code> 就是 cmdlet</p><p><code>Get-Process</code> 获取所有进程, 然后通过管道将其传递给 <code>Where-Object</code>, 该命令过滤出进程名为 <code>explorer</code> 的进程, 然后通过将这些进程传递给 <code>Stop-Process</code> 来停止这些进程; 最终实现的效果就是会关闭当前打开的所有文件资源管理器</p><blockquote><p>PS: 由于 Windows 任务栏也是和 explorer 绑一起的, 所以执行命令后也会看到任务栏消失, 然后 explorer 进程重启恢复任务栏</p></blockquote><p>cmdlet 是 powershell 中的命令, 是一种轻量级的命令, 他们通常以 <code>动词-名词</code> 的形式命令, 如上述代码中的 <code>Get-Porcess</code>, <code>Stop-Process</code>; cmdlet 提供了在 PowerShell 中执行各种操作的功能单元</p></blockquote><p>script 就像一个 PowerShell 代码块, 可以包含多行代码以及函数和其他属性;</p><p>当 command 中有多个 cmdlet 或 script 时, 第一个 cmdlet/scirpt 的输出将被 piped into 第二个 cmdlet/script 的输入中, 例如上面示例中的 <code>Get-Process</code> 的输出就通过 pipe <code>|</code> 送给了 <code>Where-Object</code> 作输入</p><p>每个 cmdlet/script 在运行时可以没有 <code>parameter/argument</code>;</p><blockquote><ul><li>parameter 是指 cmdlet/script 定义中的参数, 用于接收传入的值</li><li>argument 是指 cmdlet/scirpt 调用时传入的实际值, 用于赋给 parameter</li></ul><p>例如 <code>Get-Process -Name exploere</code> 中 <code>-Name</code> 就是 <code>parameter</code>, <code>exploere</code> 就是 <code>argument</code></p></blockquote><hr><h2 id="streams-流" tabindex="-1"><a class="header-anchor" href="#streams-流"><span>Streams(流)</span></a></h2><p>与使用 <code>input</code>, <code>output</code> 和 <code>error</code> 字节流的经典进程不同, PowerShell 包含 6 个(5.0 之前是 5 个)流:</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202311081355765.png" alt="img"></p><ul><li><p><code>Output/Success</code>: 正常,成功结果的默认流</p><p>可以使用 <code>Write-Output</code> 或 <code>&gt;</code> 操作符将数据/对象写入到这个流</p></li><li><p><code>Error</code>: 用于输出错误/异常信息</p><p>可以使用 <code>Write-Error</code> 或 <code>2&gt;</code> 操作符将数据发送到 Error 流</p></li><li><p><code>Warning</code>: 用于输出非致命性的警告信息</p><p>这些信息通常表示一些问题或潜在错误, 但命令仍然可以继续进行(例如提示升级 pip 版本)</p><p>可以使用 <code>Write-Warning</code> 或 <code>Write-Host -ForegroundColor Yellow</code> 将数据发送到警告流</p></li><li><p><code>Verbose</code>: 用于输出详细信息, 常用于调试目的</p><p>可以使用 <code>Write-Verbose</code> 命令或在执行命令时使用 <code>-Verbose</code> 开关来控制输出</p></li><li><p><code>Debug</code>: 用于输出调试信息, 通常包括命令内部的状态和</p><p>可以使用 <code>Write-Debug</code> 命令或在执行命令时使用 <code>-Debug</code> 开关来控制输出</p></li><li><p><code>Information</code>: 用于输出一般性的信息, 不是错误或警告, 用于提供帮助用户了解脚本正在做什么的消息</p><p>可以使用 <code>Write-Information</code> 或 <code>$InformationPreference</code> 变量来控制信息消息的显示</p></li></ul>`,26),v=n("p",null,"参考阅读:",-1),b={href:"https://devblogs.microsoft.com/scripting/understanding-streams-redirection-and-write-host-in-powershell/",target:"_blank",rel:"noopener noreferrer"},h={href:"https://devblogs.microsoft.com/scripting/weekend-scripter-welcome-to-the-powershell-information-stream/",target:"_blank",rel:"noopener noreferrer"},w=p(`<hr><h2 id="objects-对象" tabindex="-1"><a class="header-anchor" href="#objects-对象"><span>Objects(对象)</span></a></h2><p>除了拥有更多 Stream 外, PowerShell 与 stdio 的不同知乎还在于其传输的时 Object(对象) 而非 byte(字节);</p><p>虽然从技术上讲, 他们仍被表示为字节, 但在 PowerShell 层中, 这些字节级别的细节被抽象隐藏了, 在 PowerShell 层面上, 数据是以高级别的对象进行处理的, 这使得在 PowerShell 中编写和理解代码更加直观方便;</p><p>例如, 如果 C 程序运行 <code>printf(&quot;Hello World&quot;)</code>, 它讲把字节 <code>48 65 6c 6c 6f 20 57 6f 72 6c 64</code> 发送到 stdout 流。与 PowerShell 相比， <code>Write-Output &quot;Hello World&quot;</code> 将在第一个流上将字符串作为 .NET 对象发送。</p><p>这种方法的一个问题是如何通过 WSMan 等远程传输协议表示这些对象，因为这些对象不是该层的原始对象。 Microsoft 使用 CLIXML 来解决这个问题</p><blockquote><p>CLIXML 是一种 XML 格式, 通常在 PowerShell 中用于序列化和反序列化命令输出和数据</p></blockquote><hr><h2 id="process-flow" tabindex="-1"><a class="header-anchor" href="#process-flow"><span>Process Flow</span></a></h2><p>通过如下例子详细解释下 pypsrp 在执行以下脚本时会做什么:</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> pypsrp<span class="token punctuation">.</span>powershell <span class="token keyword">import</span> PowerShell<span class="token punctuation">,</span> RunspacePool
<span class="token keyword">from</span> pypsrp<span class="token punctuation">.</span>wsman <span class="token keyword">import</span> WSMan

wsman <span class="token operator">=</span> WSMan<span class="token punctuation">(</span><span class="token string">&quot;server2016.domain.local&quot;</span><span class="token punctuation">,</span> username<span class="token operator">=</span><span class="token string">&quot;vagrant&quot;</span><span class="token punctuation">,</span>
              password<span class="token operator">=</span><span class="token string">&quot;vagrant&quot;</span><span class="token punctuation">,</span>
              cert_validation<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> RunspacePool<span class="token punctuation">(</span>wsman<span class="token punctuation">)</span> <span class="token keyword">as</span> pool<span class="token punctuation">:</span>
    ps <span class="token operator">=</span> PowerShell<span class="token punctuation">(</span>pool<span class="token punctuation">)</span>
    ps<span class="token punctuation">.</span>add_cmdlet<span class="token punctuation">(</span><span class="token string">&quot;Get-PSDrive&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_parameter<span class="token punctuation">(</span><span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;C&quot;</span><span class="token punctuation">)</span>
    ps<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># we will print the first object returned back to us</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>output<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个脚本高效地在主机 <code>server2016.domain.local</code> 上运行 <code>cmdlet Get-PSDrive -Name C</code>, 如下是执行这段代码时交换信息的基本流程:</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202311081428598.png" alt="企业微信截图_16994249322263"></p><p>虽然上面使用的消息是 PSRP 协议中最常用的类型, 但基本协议中当前有 31 种不同的 PSRP 消息类型</p><hr><h2 id="message-structure-消息结构" tabindex="-1"><a class="header-anchor" href="#message-structure-消息结构"><span>Message Structure 消息结构</span></a></h2><p>如下消息是 PSRP 交换中发送的第一条消息:</p><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">s:</span>Envelope</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>rsp</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://schemas.microsoft.com/wbem/wsman/1/windows/shell<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>s</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2003/05/soap-envelope<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>wsa</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://schemas.xmlsoap.org/ws/2004/08/addressing<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>wsman</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://schemas.dmtf.org/wbem/wsman/1/wsman.xsd<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>wsmv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://schemas.microsoft.com/wbem/wsman/1/wsman.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">s:</span>Header</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">wsa:</span>Action</span> <span class="token attr-name"><span class="token namespace">s:</span>mustUnderstand</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>http://schemas.xmlsoap.org/ws/2004/09/transfer/Create<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">wsa:</span>Action</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">wsmv:</span>DataLocale</span> <span class="token attr-name"><span class="token namespace">s:</span>mustUnderstand</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xml:</span>lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en-US<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">wsman:</span>Locale</span> <span class="token attr-name"><span class="token namespace">s:</span>mustUnderstand</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xml:</span>lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en-US<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">wsman:</span>MaxEnvelopeSize</span> <span class="token attr-name"><span class="token namespace">s:</span>mustUnderstand</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>153600<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">wsman:</span>MaxEnvelopeSize</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">wsa:</span>MessageID</span><span class="token punctuation">&gt;</span></span>uuid:1C74E6AE-8C7A-4C03-99D1-C4AD3DABFD6D<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">wsa:</span>MessageID</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">wsman:</span>OperationTimeout</span><span class="token punctuation">&gt;</span></span>PT20S<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">wsman:</span>OperationTimeout</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">wsa:</span>ReplyTo</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">wsa:</span>Address</span> <span class="token attr-name"><span class="token namespace">s:</span>mustUnderstand</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>http://schemas.xmlsoap.org/ws/2004/08/addressing/role/anonymous<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">wsa:</span>Address</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">wsa:</span>ReplyTo</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">wsman:</span>ResourceURI</span> <span class="token attr-name"><span class="token namespace">s:</span>mustUnderstand</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>http://schemas.microsoft.com/powershell/Microsoft.PowerShell<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">wsman:</span>ResourceURI</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">wsmv:</span>SessionId</span> <span class="token attr-name"><span class="token namespace">s:</span>mustUnderstand</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>uuid:C6602DD7-6096-4983-A956-82B048821F4D<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">wsmv:</span>SessionId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">wsa:</span>To</span><span class="token punctuation">&gt;</span></span>http://server2016.domain.local:5985/wsman<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">wsa:</span>To</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">wsman:</span>OptionSet</span> <span class="token attr-name"><span class="token namespace">s:</span>mustUnderstand</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">wsman:</span>Option</span> <span class="token attr-name">MustComply</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>protocolversion<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">wsman:</span>Option</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">wsman:</span>OptionSet</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">s:</span>Header</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">s:</span>Body</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rsp:</span>Shell</span> <span class="token attr-name">ShellId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>5A416EA5-FB2A-4AAA-91BF-77BF51043386<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rsp:</span>InputStreams</span><span class="token punctuation">&gt;</span></span>stdin pr<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rsp:</span>InputStreams</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rsp:</span>OutputStreams</span><span class="token punctuation">&gt;</span></span>stdout<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rsp:</span>OutputStreams</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>creationXml</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://schemas.microsoft.com/powershell<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>AAAAAAAAAAEAAAAAAAAAAAMAAADHAgAAAAIAAQBaQW6l+ypKqpG/d79RBDOGAAAAAAAAAAAAAAAAAAAAADxPYmogUmVmSWQ9IjAiPjxNUz48VmVyc2lvbiBOPSJwcm90b2NvbHZlcnNpb24iPjIuMzwvVmVyc2lvbj48VmVyc2lvbiBOPSJQU1ZlcnNpb24iPjIuMDwvVmVyc2lvbj48VmVyc2lvbiBOPSJTZXJpYWxpemF0aW9uVmVyc2lvbiI+MS4xLjAuMTwvVmVyc2lvbj48L01TPjwvT2JqPgAAAAAAAAACAAAAAAAAAAADAAAC/QIAAAAEAAEAWkFupfsqSqqRv3e/UQQzhgAAAAAAAAAAAAAAAAAAAAA8T2JqIFJlZklkPSIwIj48TVM+PEkzMiBOPSJNaW5SdW5zcGFjZXMiPjE8L0kzMj48STMyIE49Ik1heFJ1bnNwYWNlcyI+MTwvSTMyPjxPYmogTj0iUFNUaHJlYWRPcHRpb25zIiBSZWZJZD0iMSI+PFROIFJlZklkPSIwIj48VD5TeXN0ZW0uTWFuYWdlbWVudC5BdXRvbWF0aW9uLlJ1bnNwYWNlcy5QU1RocmVhZE9wdGlvbnM8L1Q+PFQ+U3lzdGVtLkVudW08L1Q+PFQ+U3lzdGVtLlZhbHVlVHlwZTwvVD48VD5TeXN0ZW0uT2JqZWN0PC9UPjwvVE4+PFRvU3RyaW5nPkRlZmF1bHQ8L1RvU3RyaW5nPjxJMzI+MDwvSTMyPjwvT2JqPjxPYmogTj0iQXBhcnRtZW50U3RhdGUiIFJlZklkPSIyIj48VE4gUmVmSWQ9IjEiPjxUPlN5c3RlbS5NYW5hZ2VtZW50LkF1dG9tYXRpb24uUnVuc3BhY2VzLkFwYXJ0bWVudFN0YXRlPC9UPjxUPlN5c3RlbS5FbnVtPC9UPjxUPlN5c3RlbS5WYWx1ZVR5cGU8L1Q+PFQ+U3lzdGVtLk9iamVjdDwvVD48L1ROPjxUb1N0cmluZz5VTktOT1dOPC9Ub1N0cmluZz48STMyPjI8L0kzMj48L09iaj48T2JqIE49Ikhvc3RJbmZvIiBSZWZJZD0iMyI+PE1TPjxCIE49Il9pc0hvc3ROdWxsIj50cnVlPC9CPjxCIE49Il9pc0hvc3RVSU51bGwiPnRydWU8L0I+PEIgTj0iX2lzSG9zdFJhd1VJTnVsbCI+dHJ1ZTwvQj48QiBOPSJfdXNlUnVuc3BhY2VIb3N0Ij50cnVlPC9CPjwvTVM+PC9PYmo+PE5pbCBOPSJBcHBsaWNhdGlvbkFyZ3VtZW50cyIgLz48L01TPjwvT2JqPg==<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>creationXml</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rsp:</span>Shell</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">s:</span>Body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">s:</span>Envelope</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>其中的长串 base64 编码信息解码并去除非 base64 字符后得到:</p><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Obj</span> <span class="token attr-name">RefId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MS</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Version</span> <span class="token attr-name">N</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>protocolversion<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Version</span> <span class="token attr-name">N</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>PSVersion<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Version</span> <span class="token attr-name">N</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>SerializationVersion<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>1.1.0.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MS</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Obj</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Obj</span> <span class="token attr-name">RefId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MS</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>I32</span> <span class="token attr-name">N</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>MinRunspaces<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>I32</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>I32</span> <span class="token attr-name">N</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>MaxRunspaces<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>I32</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Obj</span> <span class="token attr-name">N</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>PSThreadOptions<span class="token punctuation">&quot;</span></span> <span class="token attr-name">RefId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TN</span> <span class="token attr-name">RefId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">&gt;</span></span>System.Management.Automation.Runspaces.PSThreadOptions<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>T</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">&gt;</span></span>System.Enum<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>T</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">&gt;</span></span>System.ValueType<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>T</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">&gt;</span></span>System.Object<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>T</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TN</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToString</span><span class="token punctuation">&gt;</span></span>Default<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToString</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>I32</span><span class="token punctuation">&gt;</span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>I32</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Obj</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Obj</span> <span class="token attr-name">N</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ApartmentState<span class="token punctuation">&quot;</span></span> <span class="token attr-name">RefId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TN</span> <span class="token attr-name">RefId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">&gt;</span></span>System.Management.Automation.Runspaces.ApartmentState<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>T</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">&gt;</span></span>System.Enum<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>T</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">&gt;</span></span>System.ValueType<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>T</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">&gt;</span></span>System.Object<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>T</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TN</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToString</span><span class="token punctuation">&gt;</span></span>UNKNOWN<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToString</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>I32</span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>I32</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Obj</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Obj</span> <span class="token attr-name">N</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>HostInfo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">RefId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>3<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MS</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>B</span> <span class="token attr-name">N</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_isHostNull<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>B</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>B</span> <span class="token attr-name">N</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_isHostUINull<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>B</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>B</span> <span class="token attr-name">N</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_isHostRawUINull<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>B</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>B</span> <span class="token attr-name">N</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_useRunspaceHost<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>B</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MS</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Obj</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Nil</span> <span class="token attr-name">N</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ApplicationArguments<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MS</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Obj</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><hr><h2 id="wsman" tabindex="-1"><a class="header-anchor" href="#wsman"><span>WSMan</span></a></h2><p>WSMan 是一种基于 SOAP 的协议, 通过 HTTP 发送</p><blockquote><p>SOAP 是一种在计算机之间交换结构化数据的网络协议; 它使用 XML 格式传输消息, 基于应用层协议(例如 HTTP, SMTP, TCP 等)进行标记和传输</p><p>SOAP 的优点是它可以跨平台, 跨语言和跨防火墙进行通信, 是一种开放的标准, 由 W3C 维护;</p><p>缺点在于它相对复杂, 需要解析 XML 文档, 且其性能与效率不如其他轻量级协议, 如 REST; 不过虽然 SOAP 在一些情况下已经被 RESTful API 替代, 但它仍然在特定的企业和集成环境中得到广泛应用</p></blockquote>`,23),q={href:"https://www.bloggingforlogging.com/2018/08/14/powershell-remoting-on-python/",target:"_blank",rel:"noopener noreferrer"},P=p(`<hr><h2 id="安装-pypsrp" tabindex="-1"><a class="header-anchor" href="#安装-pypsrp"><span>安装 pypsrp</span></a></h2><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>pip <span class="token function">install</span> pypsrp
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>要使用 PyPSRP 需要先启用 PowerShell Remoting</p><div class="language-powershell line-numbers-mode" data-ext="powershell" data-title="powershell"><pre class="language-powershell"><code><span class="token function">Enable-PSRemoting</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202311090004919.png" alt="image-20231109000451634"></p><hr><h2 id="示例" tabindex="-1"><a class="header-anchor" href="#示例"><span>示例</span></a></h2><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token comment"># 通过 PSRP 层运行一些代码的示例</span>
<span class="token keyword">from</span> pypsrp<span class="token punctuation">.</span>client <span class="token keyword">import</span> Client

SERVER <span class="token operator">=</span> <span class="token string">&quot;192.168.1.219&quot;</span>
USERNAME <span class="token operator">=</span> <span class="token string">&quot;ARTWinSummer\\Win10Pro&quot;</span>
PASSWORD <span class="token operator">=</span> <span class="token string">&quot;Win10Pro&quot;</span>
client <span class="token operator">=</span> Client<span class="token punctuation">(</span>SERVER<span class="token punctuation">,</span> username<span class="token operator">=</span>USERNAME<span class="token punctuation">,</span> password<span class="token operator">=</span>PASSWORD<span class="token punctuation">,</span> ssl<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

script <span class="token operator">=</span> <span class="token string">r&quot;New-Item -Path C:\\temp\\folder -ItemType Directory -Verbose&quot;</span>
output<span class="token punctuation">,</span> streams<span class="token punctuation">,</span> had_errors <span class="token operator">=</span> client<span class="token punctuation">.</span>execute_ps<span class="token punctuation">(</span>script<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;HAD ERRORS: %s&quot;</span> <span class="token operator">%</span> had_errors<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;OUTPUT:\\n%s&quot;</span> <span class="token operator">%</span> output<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;ERROR:\\n%s&quot;</span> <span class="token operator">%</span> <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> streams<span class="token punctuation">.</span>error<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;DEBUG:\\n%s&quot;</span> <span class="token operator">%</span> <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> streams<span class="token punctuation">.</span>debug<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;VERBOSE:\\n%s&quot;</span> <span class="token operator">%</span> <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> streams<span class="token punctuation">.</span>verbose<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202311081510417.png" alt="image-20231108151015825"></p><p>如果再运行一次就会看到有一个错误条目, 不过 had errors 仍然为 False, 这是因为使用了 <code>execute_ps</code> 运行了这个脚本, 仅 terminating 了错误; 例如, 使用 <code>throw</code> 则会将此项变为 <code>True</code></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202311081511178.png" alt="image-20231108151101089"></p><hr><p>将其转换为低级 API 如下所示:</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token comment"># 将 basic_sample.py 转换为使用低级API的写法示例:</span>
<span class="token keyword">from</span> pypsrp<span class="token punctuation">.</span>powershell <span class="token keyword">import</span> PowerShell<span class="token punctuation">,</span> RunspacePool
<span class="token keyword">from</span> pypsrp<span class="token punctuation">.</span>wsman <span class="token keyword">import</span> WSMan

SERVER <span class="token operator">=</span> <span class="token string">&quot;192.168.1.219&quot;</span>
USERNAME <span class="token operator">=</span> <span class="token string">&quot;ARTWinSummer\\Win10Pro&quot;</span>
PASSWORD <span class="token operator">=</span> <span class="token string">&quot;Win10Pro&quot;</span>
wsman <span class="token operator">=</span> WSMan<span class="token punctuation">(</span>SERVER<span class="token punctuation">,</span> username<span class="token operator">=</span>USERNAME<span class="token punctuation">,</span> password<span class="token operator">=</span>PASSWORD<span class="token punctuation">,</span> ssl<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> RunspacePool<span class="token punctuation">(</span>wsman<span class="token punctuation">)</span> <span class="token keyword">as</span> pool<span class="token punctuation">:</span>
    ps <span class="token operator">=</span> PowerShell<span class="token punctuation">(</span>pool<span class="token punctuation">)</span>
    ps<span class="token punctuation">.</span>add_script<span class="token punctuation">(</span><span class="token string">&quot;New-Item -Path C:\\\\temp\\\\folder -ItemType Directory -Verbose&quot;</span><span class="token punctuation">)</span>
    output <span class="token operator">=</span> ps<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;HAD ERRORS: %s&quot;</span> <span class="token operator">%</span> ps<span class="token punctuation">.</span>had_errors<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;OUTPUT:\\n%s&quot;</span> <span class="token operator">%</span> <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> output<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;ERROR:\\n%s&quot;</span> <span class="token operator">%</span> <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> ps<span class="token punctuation">.</span>streams<span class="token punctuation">.</span>error<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;DEBUG:\\n%s&quot;</span> <span class="token operator">%</span> <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> ps<span class="token punctuation">.</span>streams<span class="token punctuation">.</span>debug<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;VERBOSE:\\n%s&quot;</span> <span class="token operator">%</span> <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> ps<span class="token punctuation">.</span>streams<span class="token punctuation">.</span>verbose<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202311081615458.png" alt="image-20231108161459797"></p><p>这些低级API旨在复制 <code>.Net API</code> 以处理 Runspace Pools 和 Pipelines, 具体信息可以参阅 <code>PowerShell, RunspacePool</code> 类</p><hr><h2 id="winrs-示例" tabindex="-1"><a class="header-anchor" href="#winrs-示例"><span>WInRS 示例</span></a></h2><p>pypsrp 设计之初就表明了要实现 pywinrm 的所有功能, 其中包括通过 WInRS 执行命令</p><p>和上面 PSRP 类似, 有一个 high level implementation 可用于快速上手</p><p>例如:</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> pypsrp<span class="token punctuation">.</span>client <span class="token keyword">import</span> Client

client <span class="token operator">=</span> Client<span class="token punctuation">(</span>
    <span class="token string">&quot;192.168.1.219&quot;</span><span class="token punctuation">,</span> username<span class="token operator">=</span><span class="token string">&quot;ARTWinSummer\\Win10Pro&quot;</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">&quot;Win10Pro&quot;</span><span class="token punctuation">,</span> ssl<span class="token operator">=</span><span class="token boolean">False</span>
<span class="token punctuation">)</span>

stdout<span class="token punctuation">,</span> stderr<span class="token punctuation">,</span> rc <span class="token operator">=</span> client<span class="token punctuation">.</span>execute_cmd<span class="token punctuation">(</span><span class="token string">&quot;whoami.exe /all&quot;</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">&quot;GBK&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;RC: %d&quot;</span> <span class="token operator">%</span> rc<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;STDOUT:\\n%s&quot;</span> <span class="token operator">%</span> stdout<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;STDERR:\\n%s&quot;</span> <span class="token operator">%</span> stderr<span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>其中 <code>client.execute_cmd</code> 的 <code>encoding</code> 参数默认是 <code>437(en-US)</code>, 这里需要改成 <code>GBK</code> 才能解析中文环境的 Windows 命令输出</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202311081749579.png" alt="image-20231108174930909"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202311081749988.png" alt="image-20231108174958802"></p></blockquote><p>现在将上面的写法与使用 lower level API 相比较:</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> pypsrp<span class="token punctuation">.</span>shell <span class="token keyword">import</span> Process<span class="token punctuation">,</span> SignalCode<span class="token punctuation">,</span> WinRS
<span class="token keyword">from</span> pypsrp<span class="token punctuation">.</span>wsman <span class="token keyword">import</span> WSMan
<span class="token keyword">from</span> config <span class="token keyword">import</span> SERVER<span class="token punctuation">,</span> USERNAME<span class="token punctuation">,</span> PASSWORD


wsman <span class="token operator">=</span> WSMan<span class="token punctuation">(</span>
    server<span class="token operator">=</span>SERVER<span class="token punctuation">,</span>
    username<span class="token operator">=</span>USERNAME<span class="token punctuation">,</span>
    password<span class="token operator">=</span>PASSWORD<span class="token punctuation">,</span>
    ssl<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token keyword">with</span> WinRS<span class="token punctuation">(</span>wsman<span class="token punctuation">)</span> <span class="token keyword">as</span> shell<span class="token punctuation">:</span>
    process <span class="token operator">=</span> Process<span class="token punctuation">(</span>shell<span class="token punctuation">,</span> <span class="token string">&quot;whoami.exe&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;/all&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    process<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token punctuation">)</span>
    process<span class="token punctuation">.</span>signal<span class="token punctuation">(</span>SignalCode<span class="token punctuation">.</span>CTRL_C<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;RC: %d&quot;</span> <span class="token operator">%</span> process<span class="token punctuation">.</span>rc<span class="token punctuation">)</span>

<span class="token comment"># the stdout and stderr streams come back as bytes, this decodes them with GBK(用于中文)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;STDOUT:\\n%s&quot;</span> <span class="token operator">%</span> process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;GBK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;STDERR:\\n%s&quot;</span> <span class="token operator">%</span> process<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;GBK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202311090014262.png" alt="image-20231109001414210"></p><p>在这个示例中, 我们手动创建了一个 <code>Process</code> 对象, 该对象参数中包含了可执行程序(<code>whoami.exe</code>) 以及其参数 <code>/all</code>, 调用完该对象并在完成后发送停止信号; 这比其他代码要详细得多, 但是我们可以使用这些 low level interface 来实现如下操作:</p><ul><li>在同一个 WinRS Shell 中运行多个命令, 从而节省反复启动 shell 的时间</li><li>进程对象具有 <code>begin_invoke()</code>, <code>poll_invoke</code> 和 <code>end_invoke()</code> 来有效地在后台执行命令, 并且在其完成之前不会 block Python</li><li>Process 对象有一个 <code>send()</code> 方法将字节发送到远程进程的 stdin pipe</li><li>围绕 WinRS shell 和 Process 对象还有更多的配置选项, 如环境, 工作目录, 代码页等</li></ul><hr><h2 id="interop-with-secure-strings" tabindex="-1"><a class="header-anchor" href="#interop-with-secure-strings"><span>Interop with Secure Strings</span></a></h2>`,31),S={href:"https://www.bloggingforlogging.com/2018/08/14/powershell-remoting-on-python/",target:"_blank",rel:"noopener noreferrer"},A=n("hr",null,null,-1);function y(R,f){const a=o("ExternalLinkIcon");return c(),l("div",null,[i,n("p",null,[s("PyPSRP 是 "),n("a",r,[s("Jordan Borean"),t(a)]),s(" 编写的一个 python 库, 他只关注仅允许 WSMan 传输的 "),k,s(", 这个库旨在 PSRP 层上运行, 而其他第三方库一般只是提供了 WinRS 组件;")]),d,n("blockquote",null,[n("p",null,[s("这部分内容推荐到 "),n("a",m,[s("PowerShell Remoting on Python – Blogging for Logging"),t(a)]),s(" 中阅读, 这里只摘录与讨论一些个人比较关注的概念")])]),g,n("blockquote",null,[v,n("ul",null,[n("li",null,[s("[Understanding Streams, Redirection, and Write-Host in PowerShell - Scripting Blog "),n("a",b,[s("archived] (microsoft.com)"),t(a)])]),n("li",null,[s("[Weekend Scripter: Welcome to the PowerShell Information Stream - Scripting Blog "),n("a",h,[s("archived](microsoft.com)"),t(a)])])])]),w,n("p",null,[s("关于具体这些 XML 各层的含义可以阅读 "),n("a",q,[s("PowerShell Remoting on Python – Blogging for Logging"),t(a)]),s(", 这里暂且不做讨论")]),P,n("p",null,[s("PyPSRP 作者认为这是一个非常重要的特性, 不过目前个人对此需求不大, 这里 mark 一下, 需要了解的话可以参阅 "),n("a",S,[s("PowerShell Remoting on Python – Blogging for Logging"),t(a)])]),A])}const W=e(u,[["render",y],["__file","PyPSRP.html.vue"]]),B=JSON.parse('{"path":"/Language/Python/libs/PyPSRP/PyPSRP.html","title":"PYPSRP","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"Runspace Pool and Runspaces 运行空间池和运行空间","slug":"runspace-pool-and-runspaces-运行空间池和运行空间","link":"#runspace-pool-and-runspaces-运行空间池和运行空间","children":[]},{"level":2,"title":"Pileline 管道","slug":"pileline-管道","link":"#pileline-管道","children":[]},{"level":2,"title":"Statements 语句","slug":"statements-语句","link":"#statements-语句","children":[]},{"level":2,"title":"Commands 命令","slug":"commands-命令","link":"#commands-命令","children":[]},{"level":2,"title":"Streams(流)","slug":"streams-流","link":"#streams-流","children":[]},{"level":2,"title":"Objects(对象)","slug":"objects-对象","link":"#objects-对象","children":[]},{"level":2,"title":"Process Flow","slug":"process-flow","link":"#process-flow","children":[]},{"level":2,"title":"Message Structure 消息结构","slug":"message-structure-消息结构","link":"#message-structure-消息结构","children":[]},{"level":2,"title":"WSMan","slug":"wsman","link":"#wsman","children":[]},{"level":2,"title":"安装 pypsrp","slug":"安装-pypsrp","link":"#安装-pypsrp","children":[]},{"level":2,"title":"示例","slug":"示例","link":"#示例","children":[]},{"level":2,"title":"WInRS 示例","slug":"winrs-示例","link":"#winrs-示例","children":[]},{"level":2,"title":"Interop with Secure Strings","slug":"interop-with-secure-strings","link":"#interop-with-secure-strings","children":[]}],"git":{"createdTime":1699597492000,"updatedTime":1700064481000,"contributors":[{"name":"233PC","email":"ayusummer233@gmail.com","commits":1},{"name":"Ayusummer","email":"ayusummer233@gmail.com","commits":1}]},"readingTime":{"minutes":9.99,"words":2998},"filePathRelative":"Language/Python/libs/PyPSRP/PyPSRP.md","localizedDate":"2023年11月10日","excerpt":"\\n<ul>\\n<li><a href=\\"#pypsrp\\">PYPSRP</a>\\n<ul>\\n<li><a href=\\"#runspace-pool-and-runspaces-%E8%BF%90%E8%A1%8C%E7%A9%BA%E9%97%B4%E6%B1%A0%E5%92%8C%E8%BF%90%E8%A1%8C%E7%A9%BA%E9%97%B4\\">Runspace Pool and Runspaces 运行空间池和运行空间</a></li>\\n<li><a href=\\"#pileline-%E7%AE%A1%E9%81%93\\">Pileline 管道</a></li>\\n<li><a href=\\"#statements-%E8%AF%AD%E5%8F%A5\\">Statements 语句</a></li>\\n<li><a href=\\"#commands-%E5%91%BD%E4%BB%A4\\">Commands 命令</a></li>\\n<li><a href=\\"#streams%E6%B5%81\\">Streams(流)</a></li>\\n<li><a href=\\"#objects%E5%AF%B9%E8%B1%A1\\">Objects(对象)</a></li>\\n<li><a href=\\"#process-flow\\">Process Flow</a></li>\\n<li><a href=\\"#message-structure-%E6%B6%88%E6%81%AF%E7%BB%93%E6%9E%84\\">Message Structure 消息结构</a></li>\\n<li><a href=\\"#wsman\\">WSMan</a></li>\\n<li><a href=\\"#%E5%AE%89%E8%A3%85-pypsrp\\">安装 pypsrp</a></li>\\n<li><a href=\\"#%E7%A4%BA%E4%BE%8B\\">示例</a></li>\\n<li><a href=\\"#winrs-%E7%A4%BA%E4%BE%8B\\">WInRS 示例</a></li>\\n<li><a href=\\"#interop-with-secure-strings\\">Interop with Secure Strings</a></li>\\n</ul>\\n</li>\\n</ul>"}');export{W as comp,B as data};
