import{_ as r}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as d,o,c,b as p,w as a,e as n,d as s,a as e}from"./app-DxMJFouC.js";const u={},m=n('<h1 id="postgresql" tabindex="-1"><a class="header-anchor" href="#postgresql"><span>PostgreSQL</span></a></h1><ul><li><a href="#postgresql">PostgreSQL</a><ul><li><a href="#%E5%AE%89%E8%A3%85">安装</a></li><li><a href="#%E8%AE%BE%E7%BD%AE%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE">设置远程访问</a></li><li><a href="#%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C">基础操作</a></li><li><a href="#sqlalchemy%E6%93%8D%E4%BD%9C">sqlalchemy操作</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%90%8C%E6%AD%A5">数据库同步</a><ul><li><a href="#%E9%80%BB%E8%BE%91%E5%A4%8D%E5%88%B6">逻辑复制</a></li></ul></li></ul></li></ul><hr><h2 id="安装" tabindex="-1"><a class="header-anchor" href="#安装"><span>安装</span></a></h2>',4),g=e("div",{class:"language-bash line-numbers-mode","data-ext":"sh","data-title":"sh"},[e("pre",{class:"language-bash"},[e("code",null,[e("span",{class:"token comment"},"# 更新软件包列表"),s(`
`),e("span",{class:"token function"},"sudo"),s(),e("span",{class:"token function"},"apt"),s(` update
`),e("span",{class:"token comment"},"# 安装PostgreSQL"),s(`
`),e("span",{class:"token function"},"sudo"),s(),e("span",{class:"token function"},"apt"),s(),e("span",{class:"token function"},"install"),s(` postgresql postgresql-contrib
`),e("span",{class:"token comment"},"# 安装完成后，PostgreSQL 服务将自动启动。你可以通过以下命令检查它是否正在运行"),s(`
`),e("span",{class:"token function"},"sudo"),s(` systemctl status postgresql
`),e("span",{class:"token comment"},"# 安装完成后，默认情况下会创建一个名为postgres的系统用户，该用户拥有对PostgreSQL服务器的超级用户权限。你可以切换到该用户并使用以下命令进入PostgreSQL命令行界面,可以通过 \\q 回车退出"),s(`
`),e("span",{class:"token function"},"sudo"),s(),e("span",{class:"token parameter variable"},"-i"),s(),e("span",{class:"token parameter variable"},"-u"),s(` postgres
psql
`)])]),e("div",{class:"line-numbers","aria-hidden":"true"},[e("div",{class:"line-number"}),e("div",{class:"line-number"}),e("div",{class:"line-number"}),e("div",{class:"line-number"}),e("div",{class:"line-number"}),e("div",{class:"line-number"}),e("div",{class:"line-number"}),e("div",{class:"line-number"}),e("div",{class:"line-number"})])],-1),h=e("ul",null,[e("li",null,[e("code",null,"postgresql-contrib"),s(" 是 PostgreSQL 数据库的一个附加包，包含了一些附加功能和扩展模块，可以增强 PostgreSQL 的功能。这些功能可能包括各种数据类型、函数、插件等，可以用于处理更复杂的数据库需求或提供额外的功能。")])],-1),v=e("p",null,[e("img",{src:"http://cdn.ayusummer233.top/DailyNotes/202404081648820.png",alt:"image-20240408164820725"})],-1),b=n(`<hr><h2 id="设置远程访问" tabindex="-1"><a class="header-anchor" href="#设置远程访问"><span>设置远程访问</span></a></h2><p>在PostgreSQL服务器上，打开配置文件<code>postgresql.conf</code>，通常于<code>/etc/postgresql/{version}/main/postgresql.conf</code></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202404081653095.png" alt="image-20240408165346376"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202404081656674.png" alt="image-20240408165614574"></p><p>可以使用 <code>*</code> 来匹配所有的 IP, 亦可以指定监听的网卡 IP (本机网卡IP)列表, 例如:</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">listen_addresses</span> <span class="token punctuation">=</span> <span class="token value attr-value">&#39;localhost,192.168.1.100&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>然后编辑同级目录下的 <code>pg_hba.conf</code> 来设置允许连接到此数据库的 IP 段</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202404081710795.png" alt="image-20240408171001717"></p><p>例如</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token comment"># IPv4 local connections:</span>
<span class="token key attr-name">host</span> <span class="token value attr-value">   all             all             192.168.1.0/24            scram-sha-256</span>
<span class="token key attr-name">host</span> <span class="token value attr-value">   all             all             10.0.0.0/24               scram-sha-256</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看当前的用户列表:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token parameter variable">-u</span> postgres psql
<span class="token punctuation">\\</span>du
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202404081714323.png" alt="image-20240408171416256"></p><p>可以使用如下命令修改 <code>postgres</code> 用户的密码为 <code>new_password</code></p><div class="language-postgresql line-numbers-mode" data-ext="postgresql" data-title="postgresql"><pre class="language-postgresql"><code>ALTER USER postgres PASSWORD &#39;new_password&#39;;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202404081717005.png" alt="image-20240408171721932"></p><p>完成上述配置后重启 Postgres</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">sudo</span> systemctl restart postgresql
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>之后就可以正常通过配置的 <code>listen_address</code> 以及 Postgres 端口通过允许连接的 host IP 段的主机连接到 Postgres 数据库了</p><blockquote><p>不需要考虑 md5 或是 scram-sha-256 的密码加密方案, 在使用数据库管理工具连接 Postgres 的时候会自动协商</p></blockquote><p><img src="http://cdn.ayusummer233.top/DailyNotes/202404081741964.png" alt="image-20240408174158805"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202404081742654.png" alt="image-20240408174213587"></p><hr><h2 id="基础操作" tabindex="-1"><a class="header-anchor" href="#基础操作"><span>基础操作</span></a></h2><div class="language-postgresql line-numbers-mode" data-ext="postgresql" data-title="postgresql"><pre class="language-postgresql"><code>-- 创建数据库 mydatabase
CREATE DATABASE mydatabase;
--- 将 mydatabase 修改为 samplea
ALTER DATABASE mydatabase RENAME TO sample;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="sqlalchemy操作" tabindex="-1"><a class="header-anchor" href="#sqlalchemy操作"><span>sqlalchemy操作</span></a></h2><p>除了需要安装 SQLAlchemy 外还需要安装 psycopg2 库(PostgreSQL 数据库适配器), 它允许 Python 应用程序与 PostgreSQL 数据库进行交互</p><p>在安装 psycopg2 库前需要先安装 PostgreSQL 客户端库:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> libpq-dev
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>然后再安装 psycopg2</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>pip <span class="token function">install</span> psycopg2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><hr><h2 id="数据库同步" tabindex="-1"><a class="header-anchor" href="#数据库同步"><span>数据库同步</span></a></h2><ul><li><strong>流复制（Streaming Replication）</strong>：配置 PostgreSQL 流复制，将源数据库设置为主服务器（Primary），目标数据库设置为从服务器（Standby），然后使用流复制将数据同步到目标数据库。这种方法可以保持数据的实时同步，并且不会产生不必要的网络流量。</li><li><strong>逻辑复制（Logical Replication）</strong>：逻辑复制允许你只复制感兴趣的表或数据，而不是整个数据库。你可以设置逻辑复制订阅，并选择要复制的表，以减少不必要的数据传输。</li></ul><hr><h3 id="逻辑复制" tabindex="-1"><a class="header-anchor" href="#逻辑复制"><span>逻辑复制</span></a></h3><p>在 Postgre 中, 要使用逻辑复制, 需要确保 <code>wal_level</code> 至少为 <code>logical</code>, 这样 PostgreSQL 才能生成逻辑复制所需的 WAL 日志</p><blockquote><p>WAL 日志(Write-Ahead Logging)是数据库系统中的一种技术, 用于确保数据持久性和事务的原子性</p><p>WAL 日志记录了数据库中发生的所有变更操作, 例如插入, 更新和删除操作, 以及相关的事务信息</p></blockquote><p>修改 <code>postgresql.conf</code> 中的 <code>wal_level</code> 设置为 <code>logical</code> 即可:</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202404091557518.png" alt="image-20240409155715278"></p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># 重启 PostgreSQL</span>
<span class="token function">sudo</span> systemctl restart postgresql
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>主数据库创建逻辑复制源:</p><div class="language-postgresql line-numbers-mode" data-ext="postgresql" data-title="postgresql"><pre class="language-postgresql"><code>-- 连接到目标数据库
\\c my_database
-- 创建逻辑订阅
CREATE PUBLICATION my_pub FOR TABLE my_table;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在从数据库中设置逻辑复制订阅</p><div class="language-postgresql line-numbers-mode" data-ext="postgresql" data-title="postgresql"><pre class="language-postgresql"><code>-- 创建逻辑复制订阅
CREATE SUBSCRIPTION my_sub CONNECTION &#39;dbname=my_db host=xx.xx.xx.xx port=5432 user=postgres password=xxx&#39; PUBLICATION my_pub;
-- 启用订阅
ALTER SUBSCRIPTION my_sub ENABLE;
-- 关闭订阅
ALTER SUBSCRIPTION my_sub DISABLE;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr>`,48);function E(A,y){const l=d("Tabs");return o(),c("div",null,[m,p(l,{id:"48",data:[{id:"Ubuntu"}],active:0},{title0:a(({value:t,isActive:i})=>[s("Ubuntu")]),tab0:a(({value:t,isActive:i})=>[g,h,v]),_:1}),b])}const k=r(u,[["render",E],["__file","PostgreSQL.html.vue"]]),B=JSON.parse('{"path":"/%E5%90%8E%E7%AB%AF/%E6%95%B0%E6%8D%AE%E5%BA%93/PostgreSQL.html","title":"PostgreSQL","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"安装","slug":"安装","link":"#安装","children":[]},{"level":2,"title":"设置远程访问","slug":"设置远程访问","link":"#设置远程访问","children":[]},{"level":2,"title":"基础操作","slug":"基础操作","link":"#基础操作","children":[]},{"level":2,"title":"sqlalchemy操作","slug":"sqlalchemy操作","link":"#sqlalchemy操作","children":[]},{"level":2,"title":"数据库同步","slug":"数据库同步","link":"#数据库同步","children":[{"level":3,"title":"逻辑复制","slug":"逻辑复制","link":"#逻辑复制","children":[]}]}],"git":{"createdTime":1712828518000,"updatedTime":1712828518000,"contributors":[{"name":"Ayusummer","email":"ayusummer233@gmail.com","commits":1}]},"readingTime":{"minutes":3.38,"words":1014},"filePathRelative":"后端/数据库/PostgreSQL.md","localizedDate":"2024年4月11日","excerpt":"\\n<ul>\\n<li><a href=\\"#postgresql\\">PostgreSQL</a>\\n<ul>\\n<li><a href=\\"#%E5%AE%89%E8%A3%85\\">安装</a></li>\\n<li><a href=\\"#%E8%AE%BE%E7%BD%AE%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE\\">设置远程访问</a></li>\\n<li><a href=\\"#%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C\\">基础操作</a></li>\\n<li><a href=\\"#sqlalchemy%E6%93%8D%E4%BD%9C\\">sqlalchemy操作</a></li>\\n<li><a href=\\"#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%90%8C%E6%AD%A5\\">数据库同步</a>\\n<ul>\\n<li><a href=\\"#%E9%80%BB%E8%BE%91%E5%A4%8D%E5%88%B6\\">逻辑复制</a></li>\\n</ul>\\n</li>\\n</ul>\\n</li>\\n</ul>"}');export{k as comp,B as data};
