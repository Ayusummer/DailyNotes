import{_ as u}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as e,o as r,c as k,a as n,d as s,b as a,w as o,e as p}from"./app-DxMJFouC.js";const d={},m=n("h1",{id:"后台任务",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#后台任务"},[n("span",null,"后台任务")])],-1),b=n("ul",null,[n("li",null,[n("a",{href:"#%E5%90%8E%E5%8F%B0%E4%BB%BB%E5%8A%A1"},"后台任务"),n("ul",null,[n("li",null,[n("a",{href:"#%E4%B8%8E%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E4%B8%80%E8%B5%B7%E4%BD%BF%E7%94%A8"},"与依赖注入一起使用")])])])],-1),v=n("hr",null,null,-1),g={href:"https://www.bilibili.com/video/BV1iN411X72b?p=41",target:"_blank",rel:"noopener noreferrer"},_={href:"https://fastapi.tiangolo.com/zh/tutorial/background-tasks/",target:"_blank",rel:"noopener noreferrer"},h=p(`<p>最典型的使用是: 用户注册之后发邮件</p><p>用户能够在前端立刻得到返回, 但是接口中实行的是比较耗时的任务</p><p>引入 <code>fastapi.BackgroundTask</code> 后通过在异步函数中调用其中的 <code>add_task</code> 来添加后台任务</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token comment">##### Background Tasks 后台任务 #####</span>
<span class="token keyword">import</span> os
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> APIRouter<span class="token punctuation">,</span> BackgroundTasks<span class="token punctuation">,</span> Depends

file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#39;./README.md&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">bg_task</span><span class="token punctuation">(</span>framework<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;已续写的形式用 utf-8 编码写入README.md&quot;&quot;&quot;</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;\\n## </span><span class="token interpolation"><span class="token punctuation">{</span>framework<span class="token punctuation">}</span></span><span class="token string"> 框架精讲&quot;</span></span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app08<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">&quot;/background_tasks&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">run_bg_task</span><span class="token punctuation">(</span>framework<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> background_tasks<span class="token punctuation">:</span> BackgroundTasks<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    :param framework: 被调用的后台任务函数的参数
    :param background_tasks: FastAPI.BackgroundTasks
    :return:
    &quot;&quot;&quot;</span>
    background_tasks<span class="token punctuation">.</span>add_task<span class="token punctuation">(</span>bg_task<span class="token punctuation">,</span> framework<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;任务已在后台运行&quot;</span><span class="token punctuation">}</span>


<span class="token keyword">def</span> <span class="token function">continue_write_readme</span><span class="token punctuation">(</span>background_tasks<span class="token punctuation">:</span> BackgroundTasks<span class="token punctuation">,</span> q<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> q<span class="token punctuation">:</span>
        background_tasks<span class="token punctuation">.</span>add_task<span class="token punctuation">(</span>bg_task<span class="token punctuation">,</span> 
        <span class="token string">&quot;\\n&gt; 整体的介绍 FastAPI, 快速上手开发, 结合 API 交互文档逐个讲解核心模块的使用\\n&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> q


<span class="token decorator annotation punctuation">@app08<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">&quot;/dependency/background_tasks&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">dependency_run_bg_task</span><span class="token punctuation">(</span>q<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Depends<span class="token punctuation">(</span>continue_write_readme<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;用依赖注入的方式导入后台任务
    &quot;&quot;&quot;</span>
    <span class="token keyword">if</span> q<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;README.md更新成功&quot;</span><span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="与依赖注入一起使用" tabindex="-1"><a class="header-anchor" href="#与依赖注入一起使用"><span>与依赖注入一起使用</span></a></h2>`,6),f={href:"https://fastapi.tiangolo.com/zh/tutorial/background-tasks/#dependency-injection",target:"_blank",rel:"noopener noreferrer"},q=n("hr",null,null,-1),y=n("p",null,[s("使用 "),n("code",null,"BackgroundTasks"),s(" 还可以与依赖注入系统一起工作, 你可以在多个层次上声明一个 "),n("code",null,"BackgroundTasks"),s(" 类型的参数(可以在 "),n("code",null,"path operation"),s(" 函数中, 在 "),n("code",null,"dependency(dependable)"),s(" 中, 亦可以在 "),n("code",null,"sub-dependency"),s(" 等处声明)")],-1),B=n("div",{class:"language-python line-numbers-mode","data-ext":"py","data-title":"py"},[n("pre",{class:"language-python"},[n("code",null,[n("span",{class:"token comment"},"# Python 3.10 and above"),s(`
`),n("span",{class:"token keyword"},"from"),s(" fastapi "),n("span",{class:"token keyword"},"import"),s(" BackgroundTasks"),n("span",{class:"token punctuation"},","),s(" Depends"),n("span",{class:"token punctuation"},","),s(` FastAPI

app `),n("span",{class:"token operator"},"="),s(" FastAPI"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`


`),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"write_log"),n("span",{class:"token punctuation"},"("),s("message"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token builtin"},"str"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"with"),s(),n("span",{class:"token builtin"},"open"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"log.txt"'),n("span",{class:"token punctuation"},","),s(" mode"),n("span",{class:"token operator"},"="),n("span",{class:"token string"},'"a"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"as"),s(" log"),n("span",{class:"token punctuation"},":"),s(`
        log`),n("span",{class:"token punctuation"},"."),s("write"),n("span",{class:"token punctuation"},"("),s("message"),n("span",{class:"token punctuation"},")"),s(`


`),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"get_query"),n("span",{class:"token punctuation"},"("),s("background_tasks"),n("span",{class:"token punctuation"},":"),s(" BackgroundTasks"),n("span",{class:"token punctuation"},","),s(" q"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token builtin"},"str"),s(),n("span",{class:"token operator"},"|"),s(),n("span",{class:"token boolean"},"None"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token boolean"},"None"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"if"),s(" q"),n("span",{class:"token punctuation"},":"),s(`
        message `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string-interpolation"},[n("span",{class:"token string"},'f"found query: '),n("span",{class:"token interpolation"},[n("span",{class:"token punctuation"},"{"),s("q"),n("span",{class:"token punctuation"},"}")]),n("span",{class:"token string"},'\\n"')]),s(`
        background_tasks`),n("span",{class:"token punctuation"},"."),s("add_task"),n("span",{class:"token punctuation"},"("),s("write_log"),n("span",{class:"token punctuation"},","),s(" message"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(` q


`),n("span",{class:"token decorator annotation punctuation"},[s("@app"),n("span",{class:"token punctuation"},"."),s("post")]),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"/send-notification/{email}"'),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"send_notification"),n("span",{class:"token punctuation"},"("),s(`
    email`),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token builtin"},"str"),n("span",{class:"token punctuation"},","),s(" background_tasks"),n("span",{class:"token punctuation"},":"),s(" BackgroundTasks"),n("span",{class:"token punctuation"},","),s(` 
    q`),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token builtin"},"str"),s(),n("span",{class:"token operator"},"="),s(" Depends"),n("span",{class:"token punctuation"},"("),s("get_query"),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    message `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string-interpolation"},[n("span",{class:"token string"},'f"message to '),n("span",{class:"token interpolation"},[n("span",{class:"token punctuation"},"{"),s("email"),n("span",{class:"token punctuation"},"}")]),n("span",{class:"token string"},'\\n"')]),s(`
    background_tasks`),n("span",{class:"token punctuation"},"."),s("add_task"),n("span",{class:"token punctuation"},"("),s("write_log"),n("span",{class:"token punctuation"},","),s(" message"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token punctuation"},"{"),n("span",{class:"token string"},'"message"'),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token string"},'"Message sent"'),n("span",{class:"token punctuation"},"}"),s(`

`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),w=p('<p><img src="http://cdn.ayusummer233.top/img/202210311745358.png" alt="image-20221031174537122"></p><p>在这个示例中 query 参数传入 <code>email</code> 和 <code>q</code></p><p>接口在处理完 <code>email</code> 生成 <code>message</code> 并返回给用户后会将 <code>message</code> 传给后台任务 <code>weite_log</code> 来记录日志</p><p>如果 query 参数中有 <code>q</code>, 那么它会在 <code>get_query</code> 函数中处理然后创给后台任务 <code>write_log</code> 来记录日志</p><hr>',5);function E(A,T){const t=e("ExternalLinkIcon"),c=e("Tabs");return r(),k("div",null,[m,b,v,n("blockquote",null,[n("p",null,[n("a",g,[s("【独家新技术】从0到1学习 FastAPI 框架的所有知识点_哔哩哔哩_bilibili"),a(t)])]),n("p",null,[n("a",_,[s("Background Tasks - FastAPI (tiangolo.com)"),a(t)])])]),h,n("blockquote",null,[n("p",null,[n("a",f,[s("Background Tasks - FastAPI (tiangolo.com)"),a(t)])]),q]),y,a(c,{id:"49",data:[{id:"Python 3.10 and above"}],active:0},{title0:o(({value:l,isActive:i})=>[s("Python 3.10 and above")]),tab0:o(({value:l,isActive:i})=>[B]),_:1}),w])}const I=u(d,[["render",E],["__file","后台任务.html.vue"]]),x=JSON.parse('{"path":"/%E5%90%8E%E7%AB%AF/FastAPI/%E5%90%8E%E5%8F%B0%E4%BB%BB%E5%8A%A1.html","title":"后台任务","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"与依赖注入一起使用","slug":"与依赖注入一起使用","link":"#与依赖注入一起使用","children":[]}],"git":{"createdTime":1714457095000,"updatedTime":1714457095000,"contributors":[{"name":"233JG","email":"ayusummer233@gmail.com","commits":1}]},"readingTime":{"minutes":1.85,"words":554},"filePathRelative":"后端/FastAPI/后台任务.md","localizedDate":"2024年4月30日","excerpt":"\\n<ul>\\n<li><a href=\\"#%E5%90%8E%E5%8F%B0%E4%BB%BB%E5%8A%A1\\">后台任务</a>\\n<ul>\\n<li><a href=\\"#%E4%B8%8E%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E4%B8%80%E8%B5%B7%E4%BD%BF%E7%94%A8\\">与依赖注入一起使用</a></li>\\n</ul>\\n</li>\\n</ul>\\n<hr>\\n<blockquote>\\n<p><a href=\\"https://www.bilibili.com/video/BV1iN411X72b?p=41\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">【独家新技术】从0到1学习 FastAPI 框架的所有知识点_哔哩哔哩_bilibili</a></p>\\n<p><a href=\\"https://fastapi.tiangolo.com/zh/tutorial/background-tasks/\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">Background Tasks - FastAPI (tiangolo.com)</a></p>\\n</blockquote>"}');export{I as comp,x as data};
