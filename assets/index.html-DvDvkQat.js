import{_ as d}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as p,o as u,c as m,a,d as e,b as s,w as n,e as i}from"./app-DxMJFouC.js";const v={},h=i('<h1 id="postfix" tabindex="-1"><a class="header-anchor" href="#postfix"><span>Postfix</span></a></h1><ul><li><a href="#postfix">Postfix</a><ul><li><a href="#%E9%83%A8%E7%BD%B2">部署</a><ul><li><a href="#%E5%88%B6%E4%BD%9C-ssl-%E8%AF%81%E4%B9%A6">制作 SSL 证书</a></li><li><a href="#%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE-mysql">安装与配置 MySQL</a><ul><li><a href="#%E5%AE%89%E8%A3%85-mysql">安装 MySQL</a></li><li><a href="#%E6%96%B0%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8F%8A%E7%94%A8%E6%88%B7">新建数据库及用户</a></li><li><a href="#%E6%96%B0%E5%BB%BA%E8%A1%A8%E6%A0%BC">新建表格</a></li><li><a href="#%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE">插入数据</a></li></ul></li><li><a href="#%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE-postfix">安装与配置 Postfix</a><ul><li><a href="#%E5%AE%89%E8%A3%85-postfix">安装 Postfix</a></li><li><a href="#%E9%85%8D%E7%BD%AEpostfix">配置Postfix</a><ul><li><a href="#maincf">main.cf</a></li><li><a href="#mysql-virtual-mailbox-domainscf">mysql-virtual-mailbox-domains.cf</a></li><li><a href="#mysql-virtual-mailbox-mapscf">mysql-virtual-mailbox-maps.cf</a></li><li><a href="#mysql-virtual-alias-mapscf">mysql-virtual-alias-maps.cf</a></li><li><a href="#mastercf">master.cf</a></li></ul></li></ul></li><li><a href="#%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE-dovecot">安装与配置 Dovecot</a><ul><li><a href="#%E5%AE%89%E8%A3%85dovecot">安装Dovecot</a></li><li><a href="#%E9%85%8D%E7%BD%AE-dovecot">配置 Dovecot</a><ul><li><a href="#dovecot-%E4%B8%BB%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6---dovecotconf">Dovecot 主配置文件 - dovecot.conf</a></li><li><a href="#%E9%85%8D%E7%BD%AE%E7%A3%81%E7%9B%98%E8%B7%AF%E5%BE%84%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF--10-mailconf">配置磁盘路径相关信息 -10-mail.conf</a></li><li><a href="#%E9%85%8D%E7%BD%AE%E7%94%A8%E6%88%B7%E9%AA%8C%E8%AF%81%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF---10-authconf">配置用户验证相关信息 - 10-auth.conf</a></li><li><a href="#%E9%85%8D%E7%BD%AEsql-type%E9%AA%8C%E8%AF%81%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF---auth-sqlconfext">配置SQL-Type验证相关信息 - auth-sql.conf.ext</a></li><li><a href="#%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF---dovecot-sqlconfext">配置数据库连接相关信息 - dovecot-sql.conf.ext</a></li><li><a href="#%E9%85%8D%E7%BD%AE%E6%9C%AC%E5%9C%B0socket%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF---10-masterconf">配置本地socket相关信息 - 10-master.conf</a></li><li><a href="#%E9%85%8D%E7%BD%AE-ssl-%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF---10-sslconf">配置 SSL 相关信息 - 10-ssl.conf</a></li></ul></li></ul></li><li><a href="#%E6%B5%8B%E8%AF%95%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%98%AF%E5%90%A6%E6%AD%A3%E5%B8%B8">测试邮件服务器是否正常</a></li></ul></li></ul></li></ul><hr>',3),b={href:"https://www.postfix.org/",target:"_blank",rel:"noopener noreferrer"},k=a("p",null,"Postfix 是一款开源的, 高性能, 稳定且可靠的邮件服务器, 广泛用于搭建邮件系统",-1),g=a("hr",null,null,-1),E=a("h2",{id:"部署",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#部署"},[a("span",null,"部署")])],-1),y={href:"https://www.cnblogs.com/xfstu/p/17468312.html",target:"_blank",rel:"noopener noreferrer"},f={href:"https://blog.51cto.com/u_15930680/7436441",target:"_blank",rel:"noopener noreferrer"},_=a("hr",null,null,-1),A=a("h3",{id:"制作-ssl-证书",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#制作-ssl-证书"},[a("span",null,"制作 SSL 证书")])],-1),x=a("p",null,"可以购买第三方的证书也可以自行用 OpenSSL 制作, 区别就在于自己做的证书, 客户端连接服务器时会弹出是否信任的询问窗口",-1),D={href:"https://ayusummer.github.io/DailyNotes/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95/#%E4%BD%BF%E7%94%A8-openssl-%E7%94%9F%E6%88%90%E8%87%AA%E7%AD%BE%E5%90%8D%E8%AF%81%E4%B9%A6",target:"_blank",rel:"noopener noreferrer"},B=a("hr",null,null,-1),N=a("h3",{id:"安装与配置-mysql",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#安装与配置-mysql"},[a("span",null,"安装与配置 MySQL")])],-1),q=a("h4",{id:"安装-mysql",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#安装-mysql"},[a("span",null,"安装 MySQL")])],-1),S=a("div",{class:"language-bash line-numbers-mode","data-ext":"sh","data-title":"sh"},[a("pre",{class:"language-bash"},[a("code",null,[a("span",{class:"token function"},"apt"),e(` update
`),a("span",{class:"token function"},"apt"),e(),a("span",{class:"token function"},"install"),e(` mysql-server
`)])]),a("div",{class:"line-numbers","aria-hidden":"true"},[a("div",{class:"line-number"}),a("div",{class:"line-number"})])],-1),T=a("p",null,[a("img",{src:"http://cdn.ayusummer233.top/DailyNotes/202402280955220.png",alt:"image-20240228095550394"})],-1),L=a("div",{class:"language-bash line-numbers-mode","data-ext":"sh","data-title":"sh"},[a("pre",{class:"language-bash"},[a("code",null,[a("span",{class:"token comment"},"# 设置 root 密码"),e(`
`),a("span",{class:"token function"},"sudo"),e(` mysql_secure_installation
`)])]),a("div",{class:"line-numbers","aria-hidden":"true"},[a("div",{class:"line-number"}),a("div",{class:"line-number"})])],-1),P=a("p",null,"根据需求设定是否使用强密码以及其他配置项",-1),C=a("p",null,[a("img",{src:"http://cdn.ayusummer233.top/DailyNotes/202402281022600.png",alt:"image-20240228102220181"})],-1),R=a("div",{class:"language-bash line-numbers-mode","data-ext":"sh","data-title":"sh"},[a("pre",{class:"language-bash"},[a("code",null,[a("span",{class:"token comment"},"# 进入 mysql"),e(`
mysql
`),a("span",{class:"token comment"},"# 修改 root@% 密码为 new_password"),e(`
ALTER `),a("span",{class:"token environment constant"},"USER"),e(),a("span",{class:"token string"},"'root'"),e("@"),a("span",{class:"token string"},"'%'"),e(" IDENTIFIED WITH mysql_native_password BY "),a("span",{class:"token string"},"'your_new_password'"),a("span",{class:"token punctuation"},";"),e(`

`),a("span",{class:"token comment"},"# 需要通过FLUSH PRIVILEGES刷新权限表使修改生效"),e(`
FLUSH PRIVILEGES`),a("span",{class:"token punctuation"},";"),e(`
`)])]),a("div",{class:"line-numbers","aria-hidden":"true"},[a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"})])],-1),I=a("p",null,[a("img",{src:"http://cdn.ayusummer233.top/DailyNotes/202402281033455.png",alt:"image-20240228103331081"})],-1),F=a("hr",null,null,-1),M=a("h4",{id:"新建数据库及用户",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#新建数据库及用户"},[a("span",null,"新建数据库及用户")])],-1),w={href:"https://urashita.com/archives/35970",target:"_blank",rel:"noopener noreferrer"},U=i(`<div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># 使用 root 口令登录 MySQL</span>
mysql <span class="token parameter variable">-u</span> root <span class="token parameter variable">-p</span>
<span class="token comment"># 新建一个名为 mailserver 的数据库</span>
create database mailserver character <span class="token builtin class-name">set</span> utf8<span class="token punctuation">;</span>
<span class="token comment"># 新建一个名为 mailserver 的用户, 指定密码为 maillserve123</span>
create user mailserver@<span class="token string">&#39;localhost&#39;</span> identified by <span class="token string">&#39;Mail#Server@123&#39;</span><span class="token punctuation">;</span>
<span class="token comment"># 将数据库mailserver的所有权限赋给用户mailserver(Mysql5.7)</span>
grant all on mailserver.* to mailserver@<span class="token string">&#39;localhost&#39;</span> identified by <span class="token string">&#39;Mail#Server@123&#39;</span><span class="token punctuation">;</span>
<span class="token comment"># 将数据库mailserver的所有权限赋给用户mailserver(Mysql8.0)</span>
grant all on mailserver.* to mailserver@<span class="token string">&#39;localhost&#39;</span> with grant option<span class="token punctuation">;</span>

<span class="token comment"># 退出 root用户</span>
<span class="token builtin class-name">exit</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202402281122621.png" alt="image-20240228112215004"></p><hr><h4 id="新建表格" tabindex="-1"><a class="header-anchor" href="#新建表格"><span>新建表格</span></a></h4><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># 使用mailserver用户登录：</span>
mysql <span class="token parameter variable">-u</span> mailserver -p<span class="token string">&#39;Mail#Server@123&#39;</span>
<span class="token comment"># 将默认数据库切换为mailserver数据库：</span>
use mailserver<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>新建 <code>virtual_domains</code> 表用于存放本地服务器接收邮件的域名:</p><div class="language-mysql line-numbers-mode" data-ext="mysql" data-title="mysql"><pre class="language-mysql"><code>CREATE TABLE \`virtual_domains\` (
    \`id\` int(11) NOT NULL auto_increment,
    \`name\` varchar(50) NOT NULL,
    PRIMARY KEY (\`id\`)
) ENGINE = InnoDB DEFAULT CHARSET = utf8;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202402281139391.png" alt="image-20240228113927005"></p><p>新建 <code>virtual_users</code> 表作为邮件服务器的终端用户表，记录用户的邮件地址及密码(非明文密码):</p><div class="language-mysql line-numbers-mode" data-ext="mysql" data-title="mysql"><pre class="language-mysql"><code>CREATE TABLE \`virtual_users\` (
    \`id\` int(11) NOT NULL auto_increment,
    \`domain_id\` int(11) NOT NULL,
    \`password\` varchar(255) NOT NULL,
    \`email\` varchar(100) NOT NULL,
    PRIMARY KEY (\`id\`),
    UNIQUE KEY \`email\` (\`email\`),
    FOREIGN KEY (domain_id) REFERENCES virtual_domains(id) ON DELETE CASCADE
) ENGINE = InnoDB DEFAULT CHARSET = utf8;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202402281143878.png" alt="image-20240228114352591"></p><blockquote><p>PS: <code>password varchar(255) NOT NULL,</code> 的 255 是后来改的, 所以和贴出来的图中的 106 对不上, 后续用来更新密码的 dovecot 的密码太长了, 所以通过 <code>ALTER TABLE virtual_users MODIFY COLUMN password VARCHAR(255);</code> 改了下, 所以修改了这里新建表单的时候就写成 255</p></blockquote><p>新建 <code>virtual_aliases</code> 表作为邮件服务器别名表:</p><div class="language-mysql line-numbers-mode" data-ext="mysql" data-title="mysql"><pre class="language-mysql"><code>CREATE TABLE \`virtual_aliases\` (
    \`id\` int(11) NOT NULL auto_increment,
    \`domain_id\` int(11) NOT NULL,
    \`source\` varchar(100) NOT NULL,
    \`destination\` varchar(100) NOT NULL,
    PRIMARY KEY (\`id\`),
    FOREIGN KEY (domain_id) REFERENCES virtual_domains(id) ON DELETE CASCADE
) ENGINE = InnoDB DEFAULT CHARSET = utf8;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202402281334185.png" alt="image-20240228133437812"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202402281335840.png" alt="image-20240228133501390"></p><hr><h4 id="插入数据" tabindex="-1"><a class="header-anchor" href="#插入数据"><span>插入数据</span></a></h4><p>在 <code>virtual_domains</code> 表中添加测试域名数据:</p><div class="language-mysql line-numbers-mode" data-ext="mysql" data-title="mysql"><pre class="language-mysql"><code>insert into virtual_domains(id,name) values(1,&#39;mail.ayusummer.com&#39;);     
insert into virtual_domains(id,name) values(2,&#39;ayusummer.com&#39;);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202402281345963.png" alt="image-20240228134557391"></p><hr><p>在 <code>virtual_users</code> 表中添加用户数据:</p><blockquote><p>PS: <mark>关于密码的部分不用特别关注了,dovecot这玩意儿密码生成和mysql始终对不上, 后续要拿dovecot的密码来改数据库里的密码</mark></p></blockquote>`,24),O=a("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[a("pre",{class:"language-sql"},[a("code",null,[a("span",{class:"token keyword"},"insert"),e(),a("span",{class:"token keyword"},"into"),e(`
    virtual_users`),a("span",{class:"token punctuation"},"("),e("id"),a("span",{class:"token punctuation"},","),e(" domain_id"),a("span",{class:"token punctuation"},","),e(" password"),a("span",{class:"token punctuation"},","),e(" email"),a("span",{class:"token punctuation"},")"),e(`
`),a("span",{class:"token keyword"},"values"),e(`
    `),a("span",{class:"token punctuation"},"("),e(`
        `),a("span",{class:"token number"},"1"),a("span",{class:"token punctuation"},","),e(`
        `),a("span",{class:"token number"},"2"),a("span",{class:"token punctuation"},","),e(`
        ENCRYPT`),a("span",{class:"token punctuation"},"("),e(`
            `),a("span",{class:"token string"},"'zhangsan123456'"),a("span",{class:"token punctuation"},","),e(`
            CONCAT`),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'$6$'"),a("span",{class:"token punctuation"},","),e(" SUBSTRING"),a("span",{class:"token punctuation"},"("),e("SHA"),a("span",{class:"token punctuation"},"("),e("RAND"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token operator"},"-"),a("span",{class:"token number"},"16"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},")"),e(`
        `),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},","),e(`
        `),a("span",{class:"token string"},"'zhangsan@mydomain.com'"),e(`
    `),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e(`

`),a("span",{class:"token keyword"},"insert"),e(),a("span",{class:"token keyword"},"into"),e(`
    virtual_users`),a("span",{class:"token punctuation"},"("),e("id"),a("span",{class:"token punctuation"},","),e(" domain_id"),a("span",{class:"token punctuation"},","),e(" password"),a("span",{class:"token punctuation"},","),e(" email"),a("span",{class:"token punctuation"},")"),e(`
`),a("span",{class:"token keyword"},"values"),e(`
    `),a("span",{class:"token punctuation"},"("),e(`
        `),a("span",{class:"token number"},"2"),a("span",{class:"token punctuation"},","),e(`
        `),a("span",{class:"token number"},"2"),a("span",{class:"token punctuation"},","),e(`
        ENCRYPT`),a("span",{class:"token punctuation"},"("),e(`
            `),a("span",{class:"token string"},"'123456lisi'"),a("span",{class:"token punctuation"},","),e(`
            CONCAT`),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},"'$6$'"),a("span",{class:"token punctuation"},","),e(" SUBSTRING"),a("span",{class:"token punctuation"},"("),e("SHA"),a("span",{class:"token punctuation"},"("),e("RAND"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},","),e(),a("span",{class:"token operator"},"-"),a("span",{class:"token number"},"16"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},")"),e(`
        `),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},","),e(`
        `),a("span",{class:"token string"},"'lisi@mydomain.com'"),e(`
    `),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),e(`
`)])]),a("div",{class:"line-numbers","aria-hidden":"true"},[a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"})])],-1),H=a("ul",null,[a("li",null,[a("p",null,[a("code",null,"ENCRYPT('zhangsan123456', CONCAT('$6$', SUBSTRING(SHA(RAND()), -16)))"),e(": 使用 MySQL 的 "),a("code",null,"ENCRYPT"),e(" 函数对密码进行加密")]),a("p",null,[a("code",null,"ENCRYPT"),e(" 将原始密码和盐作为参数, 并使用指定算法(这里是 SHA-512)进行加密, 最终结果是经过盐处理的加密密码")]),a("ul",null,[a("li",null,[a("code",null,"zhangsan123456"),e(": 原始密码")]),a("li",null,[a("code",null,"CONCAT('$6$', SUBSTRING(SHA(RAND()), -16)"),e(": 生成一个随机的 16 位字符串, 作为加密的盐 "),a("ul",null,[a("li",null,[a("code",null,"$6$"),e(" 表示使用 SHA-512 算法进行加密")]),a("li",null,[a("code",null,"SUBSTRING(SHA(RAND()), -16)"),e(": 生成一个随机的 16 位字符串 "),a("ul",null,[a("li",null,[a("code",null,"SHA(RAND())"),e(": 生成一个随机的字符串并进行 SHA-1 加密")]),a("li",null,[a("code",null,"SUBSTRING(SHA(RAND()), -16)"),e(": 截取 SHA-1 加密后的字符串的后 16 位")])])])])])])])],-1),Q=a("hr",null,null,-1),$=a("p",null,[e("因为 "),a("code",null,"ENCRYPT"),e(" 函数采用了基于DES(Data Encryption Standard) 的加密算法，而DES是一种相对较弱的加密算法，不再被视为安全, MySQL 8.0 中不再支持 "),a("code",null,"ENCRYPT"),e(" 函数")],-1),Y=a("blockquote",null,[a("p",null,"随着时间的推移，密码学的研究不断进展，新的算法和更安全的加密方法得以发展。由于DES存在一些安全漏洞，例如密钥长度较短，易受到暴力破解等攻击")],-1),G=a("p",null,"在 MySQL 8.0 中，采用了更现代且安全的密码哈希函数，例如 SHA-256、SHA-512 等，以替代过时的加密方法。这有助于提高存储在数据库中的密码的安全性，并抵御更高级的攻击。",-1),X=a("div",{class:"language-mysql line-numbers-mode","data-ext":"mysql","data-title":"mysql"},[a("pre",{class:"language-mysql"},[a("code",null,`INSERT INTO
    virtual_users(id, domain_id, password, email)
VALUES
    (
        1,
        2,
        CONCAT(
            '$6$',
            SUBSTRING(
                SHA2(
                    CONCAT(
                        'zhangsan123456',
                        RAND()
                    ),
                    512
                ),
                -16
            )
        ),
        'zhangsan@ayusummer.com'
    );

INSERT INTO
    virtual_users(id, domain_id, password, email)
VALUES
    (
        2,
        2,
        CONCAT(
            '$6$',
            SUBSTRING(
                SHA2(
                    CONCAT(
                        '123456lisi',
                        RAND()
                    ),
                    512
                ),
                -16
            )
        ),
        'lisi@ayusummer.com'
    );
`)]),a("div",{class:"line-numbers","aria-hidden":"true"},[a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"})])],-1),z=a("ul",null,[a("li",null,[a("code",null,"CONCAT('$6$', SUBSTRING(SHA2(CONCAT('zhangsan123456', RAND()), 512), -16))"),e(": 对密码进行哈希和加盐 "),a("ul",null,[a("li",null,[a("code",null,"CONCAT(xxx,xxx)"),e(": 将两个字符串连接起来")]),a("li",null,[a("code",null,"$6$"),e(": 表示使用 SHA-512 算法进行加密")]),a("li",null,[a("code",null,"SUBSTRING(SHA2(CONCAT('zhangsan123456', RAND()), 512), -16)"),a("ul",null,[a("li",null,[a("code",null,"SUBSTRING(xx, -16)"),e(": 截取字符串的后 16 位")]),a("li",null,[a("code",null,"SHA2(CONCAT('zhangsan123456', RAND()), 512)"),e(": 对 "),a("code",null,"zhangsan123456"),e(" 和一个随机数进行 SHA-512 加密")])])])])])],-1),W=a("p",null,[a("img",{src:"http://cdn.ayusummer233.top/DailyNotes/202402281415690.png",alt:"image-20240228141555297"})],-1),V=a("p",null,[a("img",{src:"http://cdn.ayusummer233.top/DailyNotes/202402281423677.png",alt:"image-20240228142354323"})],-1),K=a("blockquote",null,[a("p",null,"更新 email 列数据可以使用:"),a("div",{class:"language-mysql line-numbers-mode","data-ext":"mysql","data-title":"mysql"},[a("pre",{class:"language-mysql"},[a("code",null,`UPDATE
    virtual_users
SET
    email = 'zhangsan@mydomain.com'
WHERE
    id = 1;
    
select * from virtual_users;
`)]),a("div",{class:"line-numbers","aria-hidden":"true"},[a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"}),a("div",{class:"line-number"})])])],-1),j=a("blockquote",null,[a("p",null,"PS: 这一节关于密码的部分看个乐呵, 后续要拿 dovecot 生成的密码覆盖掉原始密码")],-1),Z=a("p",null,null,-1),J=i(`<hr><p>在 <code>virtual_aliases</code> 表添加别名数据:</p><div class="language-mysql line-numbers-mode" data-ext="mysql" data-title="mysql"><pre class="language-mysql"><code>insert into
    virtual_aliases(id, domain_id, source, destination)
values
    (
        1,
        2,
        &#39;all@ayusummer.com&#39;,
        &#39;zhangsan@ayusummer.com&#39;
    );

insert into
    virtual_aliases(id, domain_id, source, destination)
values
    (2, 2, &#39;all@ayusummer.com&#39;, &#39;lisi@ayusummer.com&#39;);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202402281717835.png" alt="image-20240228171722085"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202402281717182.png" alt="image-20240228171733788"></p><hr><div class="language-mysql line-numbers-mode" data-ext="mysql" data-title="mysql"><pre class="language-mysql"><code># 看下各表单数据
select * from virtual_domains;  
select * from virtual_users;  
select * from virtual_aliases;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202402281726787.png" alt="image-20240228172604491"></p><hr><h3 id="安装与配置-postfix" tabindex="-1"><a class="header-anchor" href="#安装与配置-postfix"><span>安装与配置 Postfix</span></a></h3><h4 id="安装-postfix" tabindex="-1"><a class="header-anchor" href="#安装-postfix"><span>安装 Postfix</span></a></h4>`,11),aa=a("div",{class:"language-bash line-numbers-mode","data-ext":"sh","data-title":"sh"},[a("pre",{class:"language-bash"},[a("code",null,[a("span",{class:"token function"},"apt"),e(` update
`),a("span",{class:"token function"},"apt"),e(),a("span",{class:"token function"},"install"),e(` postfix  
`)])]),a("div",{class:"line-numbers","aria-hidden":"true"},[a("div",{class:"line-number"}),a("div",{class:"line-number"})])],-1),ea=a("p",null,[a("img",{src:"http://cdn.ayusummer233.top/DailyNotes/202402271616144.png",alt:"image-20240227161653598"})],-1),sa=a("ul",null,[a("li",null,[a("code",null,"No configuration"),e(": 保持默认配置")]),a("li",null,[a("code",null,"Internet site"),e(": 这是默认的配置类型, 适用于大多数情况; 邮件服务器直接连接到互联网, 并能够直接发送和接收邮件 用户输入域名时，Postfix会自动根据机器的主机名和域名生成合适的配置")]),a("li",null,[a("code",null,"Satellite System"),e(': 将此邮件服务器作为一个 "卫星" 系统, 依赖于另一个邮件服务器来处理所有入站和出站的邮件')]),a("li",null,[a("code",null,"Local Only"),e(": 仅在本地(局域网)发送邮件, 不与外部网络直接交互; 邮件仅在本地用户之间传递, 不涉及互联网邮件传输")])],-1),na=a("p",null,[e("根据需求自行选择配置, 这里以 "),a("code",null,"Internet Site"),e(" 为例")],-1),la=a("p",null,[a("img",{src:"http://cdn.ayusummer233.top/DailyNotes/202402271703555.png",alt:"image-20240227170322096"})],-1),ta=a("p",null,"选择完成后回车进入下一个页面, 输入域名",-1),ia=a("p",null,[a("img",{src:"http://cdn.ayusummer233.top/DailyNotes/202402271706858.png",alt:"image-20240227170621512"})],-1),oa=a("p",null,[e("这里如果你想让对方邮箱显示 "),a("code",null,"admin@example.org"),e(" 的话就填 "),a("code",null,"example.org")],-1),ca=a("p",null,"回车后会自动继续安装",-1),pa=a("p",null,[a("img",{src:"http://cdn.ayusummer233.top/DailyNotes/202402271708251.png",alt:"image-20240227170833859"})],-1),ra=a("p",null,"安装 Postfix-mysql",-1),da=a("div",{class:"language-bash line-numbers-mode","data-ext":"sh","data-title":"sh"},[a("pre",{class:"language-bash"},[a("code",null,[a("span",{class:"token function"},"apt"),e(),a("span",{class:"token function"},"install"),e(` postfix-mysql
`)])]),a("div",{class:"line-numbers","aria-hidden":"true"},[a("div",{class:"line-number"})])],-1),ua=a("p",null,[a("img",{src:"http://cdn.ayusummer233.top/DailyNotes/202402281743059.png",alt:"image-20240228174303512"})],-1),ma=i(`<hr><h4 id="配置postfix" tabindex="-1"><a class="header-anchor" href="#配置postfix"><span>配置Postfix</span></a></h4><h5 id="main-cf" tabindex="-1"><a class="header-anchor" href="#main-cf"><span>main.cf</span></a></h5><p>先把Postfix 的配置文件备份一下</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">cp</span> /etc/postfix//main.cf /etc/postfix/main.cf_backup_20240228
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202402281754562.png" alt="image-20240228175424199"></p><p>编辑 <code>main.cf</code></p><p>这里不做权限验证,注释掉如下几行</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token comment"># TLS parameters  </span>
<span class="token comment">#smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem  </span>
<span class="token comment">#smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key  #smtpd_use_tls=yes  </span>
<span class="token comment">#smtpd_tls_session_cache_database = btree:\${data_directory}/smtpd_scache  </span>
<span class="token comment">#smtp_tls_session_cache_database = btree:\${data_directory}/smtp_scache</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202402291646515.png" alt="image-20240229164622978"></p><p>将如下配置插入到注释代码之后:</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">smtpd_tls_cert_file</span><span class="token punctuation">=</span><span class="token value attr-value">/etc/dovecot/dovecot.pem  </span>
<span class="token key attr-name">smtpd_tls_key_file</span><span class="token punctuation">=</span><span class="token value attr-value">/etc/dovecot/private/dovecot.key  </span>
<span class="token key attr-name">smtpd_use_tls</span><span class="token punctuation">=</span><span class="token value attr-value">yes  </span>
<span class="token key attr-name">smtpd_tls_auth_only</span> <span class="token punctuation">=</span> <span class="token value attr-value">yes  </span>

<span class="token comment">#Enabling SMTP for authenticated users, and handing off authentication to Dovecot  </span>
<span class="token key attr-name">smtpd_sasl_type</span> <span class="token punctuation">=</span> <span class="token value attr-value">dovecot  </span>
<span class="token key attr-name">smtpd_sasl_path</span> <span class="token punctuation">=</span> <span class="token value attr-value">private/auth  </span>
<span class="token key attr-name">smtpd_sasl_auth_enable</span> <span class="token punctuation">=</span> <span class="token value attr-value">yes  </span>
<span class="token key attr-name">smtpd_recipient_restrictions</span> <span class="token punctuation">=</span>  <span class="token value attr-value">permit_sasl_authenticated, permit_mynetworks, reject_unauth_destination</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改 mydestination 的配置为 <code>localhost</code> 以便适应 MySQL 中的邮件配置</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403040931781.png" alt="image-20240304093101058"></p><hr><p>在配置文件末尾加上如下内容以配置不使用 LDA(Local Delivery Agent) 而是使用 Dovecot 的 LMTP 完成本地邮件投递</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token comment">#Handing off local delivery to Dovecot&#39;s LMTP, and telling it where to store mail  </span>
<span class="token key attr-name">virtual_transport</span> <span class="token punctuation">=</span> <span class="token value attr-value">lmtp:unix:private/dovecot-lmtp</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403040934550.png" alt="image-20240304093429909"></p><p>在配置文件末尾加上如下内容以配置Postfix去MySQL数据库种寻找域名、用户帐号密码及邮件别名等信息:</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token comment">#Virtual domains, users, and aliases  </span>
<span class="token key attr-name">virtual_mailbox_domains</span> <span class="token punctuation">=</span> <span class="token value attr-value">mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf  </span>
<span class="token key attr-name">virtual_mailbox_maps</span> <span class="token punctuation">=</span> <span class="token value attr-value">mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf  </span>
<span class="token key attr-name">virtual_alias_maps</span> <span class="token punctuation">=</span> <span class="token value attr-value">mysql:/etc/postfix/mysql-virtual-alias-maps.cf</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h5 id="mysql-virtual-mailbox-domains-cf" tabindex="-1"><a class="header-anchor" href="#mysql-virtual-mailbox-domains-cf"><span>mysql-virtual-mailbox-domains.cf</span></a></h5><p>新建 <code>/etc/postfix/mysql-virtual-mailbox-domains.cf</code> 内容如下:</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">user</span> <span class="token punctuation">=</span> <span class="token value attr-value">mailserver</span>
<span class="token key attr-name">password</span> <span class="token punctuation">=</span> <span class="token value attr-value">Mail#Server@123</span>
<span class="token key attr-name">hosts</span> <span class="token punctuation">=</span> <span class="token value attr-value">127.0.0.1</span>
<span class="token key attr-name">dbname</span> <span class="token punctuation">=</span> <span class="token value attr-value">mailserver</span>
<span class="token key attr-name">query</span> <span class="token punctuation">=</span> <span class="token value attr-value">SELECT 1 FROM virtual_domains WHERE name=&#39;%s&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启 Postfix 服务</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">service</span> postfix restart
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>测试配置是否正确, 如果上述配置正确, 那么如下命令执行后会返回1</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>postmap <span class="token parameter variable">-q</span> mail.ayusummer.com mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403041026014.png" alt="image-20240304102633629"></p><blockquote><p>实际效果就是按照 <code>mysql-virtual-mailbox-domains.cf</code> 的配置文件链接 mysql 数据库并切换到 mailserver 表后执行了 <code>SELECT 1 FROM virtual_domains WHERE name=&#39;mail.ayusummer.com&#39;;</code>, 如果条目存在则返回 1, 根据前面mysql 的配置可以看出来是可以查询到的</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403041028114.png" alt="image-20240304102822698"></p></blockquote><hr><h5 id="mysql-virtual-mailbox-maps-cf" tabindex="-1"><a class="header-anchor" href="#mysql-virtual-mailbox-maps-cf"><span>mysql-virtual-mailbox-maps.cf</span></a></h5><p>新建 <code>/etc/postfix/mysql-virtual-mailbox-maps.cf</code> 文件并输入如下内容:</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">user</span> <span class="token punctuation">=</span> <span class="token value attr-value">mailserver</span>
<span class="token key attr-name">password</span> <span class="token punctuation">=</span> <span class="token value attr-value">Mail#Server@123</span>
<span class="token key attr-name">hosts</span> <span class="token punctuation">=</span> <span class="token value attr-value">127.0.0.1  </span>
<span class="token key attr-name">dbname</span> <span class="token punctuation">=</span> <span class="token value attr-value">mailserver  </span>
<span class="token key attr-name">query</span> <span class="token punctuation">=</span> <span class="token value attr-value">SELECT 1 FROM virtual_users WHERE email=&#39;%s&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启Postfix服务:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">service</span> postfix restart
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>测试配置是否正确, 如果上述配置正确, 那么如下命令执行后会返回1:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>postmap <span class="token parameter variable">-q</span> lisi@ayusummer.com mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403041007618.png" alt="image-20240304100734214"></p><hr><h5 id="mysql-virtual-alias-maps-cf" tabindex="-1"><a class="header-anchor" href="#mysql-virtual-alias-maps-cf"><span>mysql-virtual-alias-maps.cf</span></a></h5><p>新建 <code>/etc/postfix/mysql-virtual-alias-maps.cf</code> 文件并输入如下内容:</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">user</span> <span class="token punctuation">=</span> <span class="token value attr-value">mailserver</span>
<span class="token key attr-name">password</span> <span class="token punctuation">=</span> <span class="token value attr-value">Mail#Server@123</span>
<span class="token key attr-name">hosts</span> <span class="token punctuation">=</span> <span class="token value attr-value">127.0.0.1  </span>
<span class="token key attr-name">dbname</span> <span class="token punctuation">=</span> <span class="token value attr-value">mailserver  </span>
<span class="token key attr-name">query</span> <span class="token punctuation">=</span> <span class="token value attr-value">SELECT destination FROM virtual_aliases WHERE source=&#39;%s&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启Postfix服务:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">service</span> postfix restart
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>测试上述配置是否正确，如果上述配置正确，则如下命令执行后返回结果应该是之前添加的别名帐号：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>postmap <span class="token parameter variable">-q</span> all@ayusummer.com mysql:/etc/postfix/mysql-virtual-alias-maps.cf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403041018498.png" alt="image-20240304101826028"></p><hr><h5 id="master-cf" tabindex="-1"><a class="header-anchor" href="#master-cf"><span>master.cf</span></a></h5>`,50),va=a("code",null,"/etc/postfix/master.cf",-1),ha=a("code",null,"submission",-1),ba=a("code",null,"smtps",-1),ka=i(`<p><img src="http://cdn.ayusummer233.top/DailyNotes/202403041710393.png" alt="image-20240304171031269"></p><p>重启Postfix服务</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">service</span> postfix restart
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>到这里关于 Postfix 服务器的配置就完成了</p><hr><h3 id="安装与配置-dovecot" tabindex="-1"><a class="header-anchor" href="#安装与配置-dovecot"><span>安装与配置 Dovecot</span></a></h3><h4 id="安装dovecot" tabindex="-1"><a class="header-anchor" href="#安装dovecot"><span>安装Dovecot</span></a></h4><p>Dovecot 是一个流行的开源邮件服务器软件，主要用于支持邮件协议的 IMAP(Internet Message Access Protocol) 和 POP3(Post Office Protocol version 3) 。它允许用户通过电子邮件客户端(如邮件应用程序或 Webmail) 访问和管理存储在服务器上的电子邮件(Dovecot会将真正的验证工作交给MySQL处理)</p><p>因为使用SSL，Dovecot会使用993「IMAP协议」及995「POP协议」与外界交流, 如果服务器有防火墙则需要放通这两个端口</p><p>在此章节中需要配置如下信息:</p><ul><li>开启Dovecot的IMAP、POP3、LMTP协议</li><li>告知Dovecot本地邮件的投档路径</li><li>连接Dovecot和MySQL数据库以验证用户身份</li><li>配置SSL加密相关信息</li></ul><hr><p>安装Dovecot最新版:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">apt</span> <span class="token function">install</span> dovecot-core dovecot-imapd dovecot-pop3d dovecot-lmtpd dovecot-mysql
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403060938038.png" alt="image-20240306093813220"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403051819585.png" alt="image-20240305181937525"></p><ul><li><code>dovecot-core</code>: Dovecot的核心组件, 包括必要的库和二进制文件; 提供了Dovecot邮件服务器的基本功能</li><li><code>dovecot-imapd</code>: Dovecot 的 IMAP 服务器模块; 允许用户使用 IMAP 协议来访问和管理邮件，通常用于接收邮件</li><li><code>dovecot-pop3d</code>: Dovecot 的 POP3 服务器模块; 允许用户使用 POP3 协议来访问和下载邮件，通常用于接收邮件</li><li><code>dovecot-lmtpd</code>: Dovecot 的 LMTP(Local Mail Transfer Protocol) 服务器模块。LMTP 通常用于传递本地邮件，特别是与其他邮件组件 (如邮件投递代理) 集成时。</li><li><code>dovecot-mysql</code>: Dovecot 的 MySQL 驱动模块; 允许 Dovecot 与 MySQL 数据库进行集成，以便存储和检索用户的邮件和相关信息</li></ul><hr><h4 id="配置-dovecot" tabindex="-1"><a class="header-anchor" href="#配置-dovecot"><span>配置 Dovecot</span></a></h4><p>需要备份与修改的配置文件如下</p><ul><li><p><code>/etc/dovecot/dovecot.conf</code> Dovecot 的主配置文件</p></li><li><p><code>/etc/dovecot/conf.d/10-mail.conf</code> Dovecot将要操作的磁盘路径相关配置信息</p></li><li><p><code>/etc/dovecot/conf.d/10-auth.conf</code> 用户验证相关配置信息</p></li><li><p><code>/etc/dovecot/conf.d/auth-sql.conf.ext</code> SQL-Type 验证相关配置信息</p></li><li><p><code>/etc/dovecot/dovecot-sql.conf.ext</code> Dovecot与数据库连接相关配置信息</p></li><li><p><code>/etc/dovecot/conf.d/10-master.conf</code> Dovecot本地socket相关配置信息</p></li><li><p><code>/etc/dovecot/conf.d/10-ssl.conf</code> 关于SSL的相关配置信息</p></li></ul><hr><h5 id="dovecot-主配置文件-dovecot-conf" tabindex="-1"><a class="header-anchor" href="#dovecot-主配置文件-dovecot-conf"><span>Dovecot 主配置文件 - dovecot.conf</span></a></h5><p>备份与修改 <code>/etc/dovecot/dovecot.conf</code>, 检查 <code>!include conf.d/*.conf</code> 这行是否有注释, 如果有则去掉该行注释以便能够正常解析 <code>conf.d</code> 中的配置项</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061036048.png" alt="image-20240306103627672"></p><p>在 <code>!include_try /usr/share/dovecot/protocols.d/*.protocol</code> 行下加入这行以启用 Dovecot 的 imap、pop3、lmtp等相关协议</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">protocols</span> <span class="token punctuation">=</span> <span class="token value attr-value">imap pop3 lmtp</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061039128.png" alt="image-20240306103920796"></p><hr><h5 id="配置磁盘路径相关信息-10-mail-conf" tabindex="-1"><a class="header-anchor" href="#配置磁盘路径相关信息-10-mail-conf"><span>配置磁盘路径相关信息 -10-mail.conf</span></a></h5><p>备份与修改 <code>/etc/dovecot/conf.d/10-mail.conf</code></p><p>配置其中的 <code>mail_location</code> 字段, 指向本地磁盘路径用于存放收到的邮件:</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">mail_location</span> <span class="token punctuation">=</span> <span class="token value attr-value">maildir:/var/mail/vhosts/%d/%n</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p><code>%d</code> 和 <code>%n</code> 是占位符，它们将被实际的域名和用户名替换，以创建每个用户的独立邮件存储路径。</p></blockquote><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061114042.png" alt="image-20240306111434731"></p><p>同时，找到文件中 <code>mail_privileged_group</code> 配置项, 将其指定为 <code>mail</code> 以使得 Dovecot 在启动时以 mail 组权限运行从而可以访问邮件存储目录</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">mail_privileged_group</span> <span class="token punctuation">=</span> <span class="token value attr-value">mail</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061110010.png" alt="image-20240306111048659"></p><p>查询下 <code>/var/mail</code> 路径的权限:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">ls</span> <span class="token parameter variable">-ld</span> /var/mail
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><strong><code>-l</code>：</strong> 以长格式（long format）显示文件或目录的详细信息 长格式包括文件/目录的权限、链接数、所有者、所属组、大小、修改日期和文件/目录名称等。</li><li><strong><code>-d</code>：</strong> 仅显示目录本身的详细信息，而不显示目录中的内容 如果不使用 <code>-d</code>，<code>ls</code> 命令将显示目录中的文件和子目录的详细信息。</li></ul><p>输出大致如下</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061115637.png" alt="image-20240306111523149"></p><ul><li><strong>第一列 (<code>drwxrwsr-x</code>)：</strong><ul><li><code>d</code>: 表示这是一个目录。</li><li><code>rwx</code>: 表示拥有者（root）有读、写和执行权限。</li><li><code>rws</code>: 表示组（mail）的用户具有读、写和执行权限，并设置了组的 setgid 位。setgid 位确保新创建的文件和目录属于与父目录相同的组（这里是 mail 组）。</li><li><code>r-x</code>: 表示其他用户有读和执行权限，但没有写权限。</li></ul></li><li><strong>第二列 (<code>3</code>)：</strong> 表示目录中包含的子目录（或链接数）的数量。</li><li><strong>第三列 (<code>root mail</code>)：</strong><ul><li><code>root</code>: 表示拥有者是 root 用户。</li><li><code>mail</code>: 表示所属组是 mail 组。</li></ul></li><li><strong>第四列 (<code>4096</code>)：</strong> 表示目录的大小，以字节为单位。</li><li>**第五列 (<code>3月 6 11:00</code>)：**表示目录的最后修改时间。</li></ul><hr><p>创建 <code>/var/mail/vhosts/</code> 文件夹给每个需要启用的域名：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/mail/vhosts/ayusummer.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><code>-p</code>: 表示递归创建目录。如果指定的目录路径中的某个父级目录不存在，<code>mkdir</code> 将会创建这些父级目录。</li></ul><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061124758.png" alt="image-20240306112452420"></p><p>新建 vmail 用户组及用户并赋权限:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">groupadd</span> <span class="token parameter variable">-g</span> <span class="token number">5000</span> vmail  
<span class="token function">useradd</span> <span class="token parameter variable">-g</span> vmail <span class="token parameter variable">-u</span> <span class="token number">5000</span> vmail <span class="token parameter variable">-d</span> /var/mail
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong><code>groupadd -g 5000 vmail</code>：</strong><ul><li><code>-g 5000</code>: 指定新创建的用户组的组ID为 5000</li><li><code>vmail</code>: 新创建的用户组的名称</li></ul></li><li><strong><code>useradd -g vmail -u 5000 vmail -d /var/mail</code>：</strong><ul><li><code>-g vmail</code>: 将新用户添加到名为 <code>vmail</code> 的用户组中</li><li><code>-u 5000</code>: 指定新用户的用户ID为 5000</li><li><code>vmail</code>: 新用户的用户名</li><li><code>-d /var/mail</code>: 指定新用户的家目录为 <code>/var/mail</code></li></ul></li></ul><blockquote><p>在Linux系统中，用户组（group）有一个唯一的标识符，称为组ID（Group ID，通常缩写为GID）。GID是一个非负整数，用于在系统中唯一标识一个用户组。</p></blockquote><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061130207.png" alt="image-20240306113018479"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061130010.png" alt="image-20240306113050515"></p><p>修改 <code>/var/mail/</code> 目录的权限, 使 vmail 用户能够访问:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">chown</span> <span class="token parameter variable">-R</span> vmail:vmail /var/mail
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><strong><code>chown</code>:</strong> 改变文件或目录所有者</li><li><strong><code>-R</code>:</strong> 递归地更改目录及其子目录和文件的所有者</li><li><strong><code>vmail:vmail</code>:</strong> 新所有者和组。前面的 <code>vmail</code> 表示新的所有者，后面的 <code>vmail</code> 表示新的组。这意味着所有文件和子目录将属于 <code>vmail</code> 用户和 <code>vmail</code> 组</li><li><strong><code>/var/mail</code>:</strong> 目标目录，即要更改所有者的目录</li></ul><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061132234.png" alt="image-20240306113247728"></p><hr><h5 id="配置用户验证相关信息-10-auth-conf" tabindex="-1"><a class="header-anchor" href="#配置用户验证相关信息-10-auth-conf"><span>配置用户验证相关信息 - 10-auth.conf</span></a></h5><p>备份与修改 \`\`/etc/dovecot/conf.d/10-auth.conf\` 文件</p><p>找到文件中 <code>disable_plaintext_auth</code> 并取消注释以启用使用明文密码进行身份验证</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061137403.png" alt="image-20240306113755867"></p><blockquote><p>如发现连不上服务器不行，可以试试注释此项</p></blockquote><p>找到文件中 <code>auth_mechanisms</code> 并将其修改为如下值:</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">auth_mechanisms</span> <span class="token punctuation">=</span> <span class="token value attr-value">plain login</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061140411.png" alt="image-20240306114028003"></p><p>默认情况下，Dovecot是允许Ubuntu系统用户登录使用的，我们需要将其禁用。找到文件中的如下内容并将其注释:</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token comment">!include auth-system.conf.ext</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>如发现连不上服务器不行，可以试试开启此项</p></blockquote><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061141984.png" alt="image-20240306114143590"></p><hr><p>开启 Dovecot 的 MySQL 支持，取消 <code>!include auth-sql.conf.ext</code> 的注释符号:</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061142284.png" alt="image-20240306114253626"></p><hr><h5 id="配置sql-type验证相关信息-auth-sql-conf-ext" tabindex="-1"><a class="header-anchor" href="#配置sql-type验证相关信息-auth-sql-conf-ext"><span>配置SQL-Type验证相关信息 - auth-sql.conf.ext</span></a></h5><p>备份与修改 <code>/etc/dovecot/conf.d/auth-sql.conf.ext</code> 文件</p><p>在文件中加入如下内容:</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">passdb</span> <span class="token value attr-value">{  </span>
<span class="token key attr-name">    driver</span> <span class="token punctuation">=</span> <span class="token value attr-value">sql  </span>
<span class="token key attr-name">    args</span> <span class="token punctuation">=</span> <span class="token value attr-value">/etc/dovecot/dovecot-sql.conf.ext  </span>
<span class="token key attr-name">}</span> <span class="token value attr-value"> </span>

<span class="token key attr-name">userdb</span> <span class="token value attr-value">{  </span>
<span class="token key attr-name">    driver</span> <span class="token punctuation">=</span> <span class="token value attr-value">static  </span>
<span class="token key attr-name">    args</span> <span class="token punctuation">=</span> <span class="token value attr-value">uid=vmail gid=vmail home=/var/mail/vhosts/%d/%n  </span>
<span class="token key attr-name">}</span> <span class="token value attr-value">                                                                   </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>driver = sql</code>: 指定使用 SQL 数据库进行密码验证</li><li><code>args = /etc/dovecot/dovecot-sql.conf.ext</code>: 指定用于 SQL 认证的配置文件路径 这个文件中会设置数据库连接信息和查询语句</li><li><code>driver = static</code>: 指定使用静态（静态配置的）用户数据库</li><li><code>args = uid=vmail gid=vmail home=/var/mail/vhosts/%d/%n</code>: 指定用户数据库的一些静态参数, 用户ID、组ID和用户的家目录。</li></ul><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061404913.png" alt="image-20240306140426435"></p><hr><h5 id="配置数据库连接相关信息-dovecot-sql-conf-ext" tabindex="-1"><a class="header-anchor" href="#配置数据库连接相关信息-dovecot-sql-conf-ext"><span>配置数据库连接相关信息 - dovecot-sql.conf.ext</span></a></h5><p>取消文件中 driver 行的注释, 并将其修改为如下:</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">driver</span> <span class="token punctuation">=</span> <span class="token value attr-value">mysql</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061417424.png" alt="image-20240306141739968"></p><p>取消文件中 connect 行的注释, 并将其修改为如下:</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">connect</span> <span class="token punctuation">=</span> <span class="token value attr-value">host=127.0.0.1 dbname=mailserver user=mailserver password=Mail#Server@123</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061419280.png" alt=""></p><p>取消文件中 default_pass_scheme 行的注释，并将其修改为如下以设置默认的密码存储方案为 SHA512-CRYPT，即使用 SHA-512 算法进行密码加密和验证:</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">default_pass_scheme</span> <span class="token punctuation">=</span> <span class="token value attr-value">SHA512-CRYPT</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061433434.png" alt="image-20240306143351934"></p><p>取消文件中 password_query 行的注释, 并将起修改为如下:</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">password_query</span> <span class="token punctuation">=</span> <span class="token value attr-value">SELECT email as user, password FROM virtual_users WHERE email=&#39;%u&#39;;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>从名为 <code>virtual_users</code> 的数据库表中选择用户的电子邮件地址 (<code>email</code>) 作为用户标识 (<code>user</code>)，以及与该用户关联的密码 (<code>password</code>)。<code>%u</code> 是 Dovecot 中用于替代实际用户名的占位符。</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061435051.png" alt="image-20240306143538478"></p><hr><p>修改目录权限:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">chown</span> <span class="token parameter variable">-R</span> vmail:dovecot /etc/dovecot
<span class="token function">chmod</span> <span class="token parameter variable">-R</span> o-rwx /etc/dovecot
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><strong><code>chown -R vmail:dovecot /etc/dovecot</code></strong></p><ul><li><code>chown</code>: 更改文件或目录的所有者</li><li><code>-R</code>: 递归地更改所有者, 包括子目录和文件</li><li><code>vmail:dovecot</code>: 新的所有者和组, 即 <code>vmail</code> 用户和 <code>dovecot</code> 组</li><li><code>/etc/dovecot</code>: 要更改所有者的目标目录</li></ul><p>将 <code>/etc/dovecot</code> 目录及其所有子目录和文件的所有者更改为 <code>vmail</code> 用户和 <code>dovecot</code> 组</p></li><li><p><strong><code>chmod -R o-rwx /etc/dovecot</code></strong></p><ul><li><code>o-rwx</code>: 移除其他用户（除所有者和组之外的用户）的读、写和执行权限。</li></ul><p>将 <code>/etc/dovecot</code> 目录及其所有子目录和文件的其他用户权限（即除了所有者和组之外的用户）设置为无读、无写和无执行权限</p></li></ul><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061448608.png" alt="image-20240306144809065"></p><hr><h5 id="配置本地socket相关信息-10-master-conf" tabindex="-1"><a class="header-anchor" href="#配置本地socket相关信息-10-master-conf"><span>配置本地socket相关信息 - 10-master.conf</span></a></h5><p>备份与修改 <code>/etc/dovecot/conf.d/10-master.conf</code> 文件</p><p>可以通过将端口设置为0，以禁用非SSL加密的IMAP和POP3协议:</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">service</span> <span class="token value attr-value">imap-login {  </span>
<span class="token key attr-name">    inet_listener</span> <span class="token value attr-value">imap {  </span>
<span class="token key attr-name">        port</span> <span class="token punctuation">=</span> <span class="token value attr-value">0   </span>
<span class="token key attr-name">    }</span> <span class="token value attr-value"> </span>
<span class="token key attr-name">    ...</span> <span class="token value attr-value"> </span>
<span class="token key attr-name">}</span> <span class="token value attr-value"> </span>

<span class="token key attr-name">service</span> <span class="token value attr-value">pop3-login {  </span>
<span class="token key attr-name">    inet_listener</span> <span class="token value attr-value">pop3 {  </span>
<span class="token key attr-name">        port</span> <span class="token punctuation">=</span> <span class="token value attr-value">0  </span>
<span class="token key attr-name">    }</span> <span class="token value attr-value"> </span>
<span class="token key attr-name">    ...</span> <span class="token value attr-value"> </span>
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里对 IMAP 以及 POP3 端口以及对应 SSL 加密端口进行配置如下:</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">service</span> <span class="token value attr-value">imap-login {</span>
<span class="token key attr-name">   inet_listener</span> <span class="token value attr-value">imap {</span>
<span class="token key attr-name">     port</span> <span class="token punctuation">=</span> <span class="token value attr-value">143</span>
   }
<span class="token key attr-name">   inet_listener</span> <span class="token value attr-value">imaps {</span>
<span class="token key attr-name">     port</span> <span class="token punctuation">=</span> <span class="token value attr-value">993</span>
<span class="token key attr-name">     ssl</span> <span class="token punctuation">=</span> <span class="token value attr-value">yes</span>
   }
    ...
<span class="token key attr-name"> }service</span> <span class="token value attr-value">pop3-login {</span>
<span class="token key attr-name">   inet_listener</span> <span class="token value attr-value">pop3 {</span>
<span class="token key attr-name">     port</span> <span class="token punctuation">=</span> <span class="token value attr-value">110</span>
   }
<span class="token key attr-name">   inet_listener</span> <span class="token value attr-value">pop3s {</span>
<span class="token key attr-name">     port</span> <span class="token punctuation">=</span> <span class="token value attr-value">995</span>
<span class="token key attr-name">     ssl</span> <span class="token punctuation">=</span> <span class="token value attr-value">yes</span>
   }
 }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061455555.png" alt="image-20240306145531028"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061456640.png" alt="image-20240306145627106"></p><hr><p>找到文件中的 service lmtp 并将其修改如下：</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">service</span> <span class="token value attr-value">lmtp {</span>
<span class="token key attr-name">  unix_listener</span> <span class="token value attr-value">/var/spool/postfix/private/dovecot-lmtp {  </span>
<span class="token key attr-name">    mode</span> <span class="token punctuation">=</span> <span class="token value attr-value">0600  </span>
<span class="token key attr-name">    user</span> <span class="token punctuation">=</span> <span class="token value attr-value">postfix  </span>
<span class="token key attr-name">    group</span> <span class="token punctuation">=</span> <span class="token value attr-value">postfix  </span>
<span class="token key attr-name">  }</span> <span class="token value attr-value"> </span>

<span class="token comment">  # Create inet listener only if you can&#39;t use the above UNIX socket</span>
<span class="token comment">  #inet_listener lmtp {</span>
<span class="token comment">    # Avoid making LMTP visible for the entire internet</span>
<span class="token comment">    #address =</span>
<span class="token comment">    #port = </span>
<span class="token comment">  #}</span>
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述是LMTP (Local Mail Transfer Protocol) 服务的设置</p>`,115),ga=a("code",null,"unix_listener",-1),Ea=a("li",null,[a("code",null,"/var/spool/postfix/private/dovecot-lmtp"),e(": 指定 LMTP 使用的 UNIX socket 路径")],-1),ya=a("li",null,[a("code",null,"mode = 0600"),e(": 设置 UNIX socket 的权限模式，这里是只允许 owner(postfix 用户) 有读写权限")],-1),fa=a("li",null,[a("code",null,"user = postfix"),e(" 和 "),a("code",null,"group = postfix"),e(": 指定 UNIX socket 的所有者和组")],-1),_a=i(`<p>Dovecot 配置中的 UNIX 监听器指的是 LMTP 服务通过 UNIX socket 进行本地通信的机制</p><p>Postfix 通过连接到 <code>/var/spool/postfix/private/dovecot-lmtp</code> 这个 UNIX socket 与 Dovecot 的 LMTP 服务进行通信</p><blockquote><p>这种本地通信方式相对于网络通信更加高效，因为它不需要经过网络协议栈，直接在操作系统内核中完成数据传输。</p></blockquote><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061459313.png" alt="image-20240306145900791"></p><hr><p>找到文件中 service auth 并将其内容修改如下:</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">service</span> <span class="token value attr-value">auth {  </span>
<span class="token comment">  # auth_socket_path points to this userdb socket by default. It&#39;s typically  </span>
<span class="token comment">  # used by dovecot-lda, doveadm, possibly imap process, etc. Its default  </span>
<span class="token comment">  # permissions make it readable only by root, but you may need to relax these  </span>
<span class="token comment">  # permissions. Users that have access to this socket are able to get a list  </span>
<span class="token comment">  # of all usernames and get results of everyone&#39;s userdb lookups.  </span>

<span class="token key attr-name">  unix_listener</span> <span class="token value attr-value">/var/spool/postfix/private/auth {  </span>
<span class="token key attr-name">    mode</span> <span class="token punctuation">=</span> <span class="token value attr-value">0666  </span>
<span class="token key attr-name">    user</span> <span class="token punctuation">=</span> <span class="token value attr-value">postfix  </span>
<span class="token key attr-name">    group</span> <span class="token punctuation">=</span> <span class="token value attr-value">postfix  </span>
<span class="token key attr-name">  }</span> <span class="token value attr-value"> </span>

<span class="token key attr-name">  unix_listener</span> <span class="token value attr-value">auth-userdb {  </span>
<span class="token key attr-name">    mode</span> <span class="token punctuation">=</span> <span class="token value attr-value">0600  </span>
<span class="token key attr-name">    user</span> <span class="token punctuation">=</span> <span class="token value attr-value">vmail  </span>
<span class="token comment">    #group =  </span>
<span class="token key attr-name">  }</span> <span class="token value attr-value"> </span>

<span class="token comment">  # Postfix smtp-auth  </span>
<span class="token comment">  #unix_listener /var/spool/postfix/private/auth {  </span>
<span class="token comment">  #       mode = 0666  </span>
<span class="token comment">  #}  </span>

<span class="token comment">  # Auth process is run as this user.  </span>
<span class="token key attr-name">  user</span> <span class="token punctuation">=</span> <span class="token value attr-value">dovecot  </span>
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><code>unix_listener</code>: 定义了一个 UNIX socket，用于 auth 服务</p></li><li><p><code>/var/spool/postfix/private/auth</code>: 指定 UNIX socket 的路径</p></li><li><p><code>mode = 0666</code>: 设置 UNIX socket 的权限模式, 允许所有用户读写</p></li><li><p><code>user = postfix</code> 和 <code>group = postfix</code>: 指定 UNIX socket 的所有者和组</p><hr></li><li><p><code>unix_listener</code>: 定义了另一个 UNIX socket, 用于用户数据库的查询</p></li><li><p><code>auth-userdb</code>: UNIX socket 的标识符</p></li><li><p><code>mode = 0600</code>: 设置 UNIX socket 的权限模式, 只允许 owner（vmail 用户） 有读写权限</p></li><li><p><code>user = vmail</code>: 指定 UNIX socket 的所有者</p><hr></li><li><p><code>user</code>: 指定 auth 进程的运行用户为 <code>dovecot</code>。</p></li></ul><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061542784.png" alt="image-20240306154246027"></p><hr><p>找到文件中 <code>service auth-worker</code> 内容并修改如下:</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">service</span> <span class="token value attr-value">auth-worker {</span>
<span class="token comment">  # Auth worker process is run as root by default, so that it can access</span>
<span class="token comment">  # /etc/shadow. If this isn&#39;t necessary, the user should be changed to</span>
<span class="token comment">  # $default_internal_user.</span>
<span class="token key attr-name">  user</span> <span class="token punctuation">=</span> <span class="token value attr-value">vmail  </span>
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>service auth-worker</code>: 定义了 <code>auth-worker</code> 服务</li><li><code>user = vmail</code>: 指定了 <code>auth-worker</code> 进程运行的用户为 <code>vmail</code></li></ul><p><code>auth-worker</code> 进程是一个处理认证请求的后台工作进程; 通过将 <code>user</code> 设置为 <code>vmail</code> 来指定这个工作进程以 <code>vmail</code> 用户的身份运行</p><hr><h5 id="配置-ssl-相关信息-10-ssl-conf" tabindex="-1"><a class="header-anchor" href="#配置-ssl-相关信息-10-ssl-conf"><span>配置 SSL 相关信息 - 10-ssl.conf</span></a></h5><p>备份与修改 <code>/etc/dovecot/conf.d/10-ssl.conf</code> 文件</p><p>找到文件中的 <code>ssl_cert</code> 项并修改内容如下</p><blockquote><p>请确保 dovecot 的 pem 文件已经存在</p><p>若使用了自己的SSL文件，请将如下内容修改为相应的路径</p></blockquote><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">ssl_cert</span> <span class="token punctuation">=</span> <span class="token value attr-value">&lt;/etc/dovecot/dovecot.pem  </span>
<span class="token key attr-name">ssl_key</span> <span class="token punctuation">=</span> <span class="token value attr-value">&lt;/etc/dovecot/private/dovecot.key</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061550427.png" alt="image-20240306155020771"></p><p>强制用户使用SSL加密:</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">ssl</span> <span class="token punctuation">=</span> <span class="token value attr-value">required</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403061556729.png" alt="image-20240306155621358"></p><p>重新启动Dovecot服务:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">service</span> dovecot restart
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><hr><h3 id="测试邮件服务器是否正常" tabindex="-1"><a class="header-anchor" href="#测试邮件服务器是否正常"><span>测试邮件服务器是否正常</span></a></h3><p>用 FoxMail测试一下</p><p>FoxMail 配置示例:</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403071343655.png" alt="image-20240307134316074"></p><blockquote><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403071451547.png" alt="image-20240307145116642"></p><p>PS: 后续成功连上之后发邮件总是有问题, 所以发件服务器没有勾选ssl</p></blockquote><p>在这里可能会发现始终因为密码错误连不上邮箱, 可以修改 <code>/etc/dovecot/conf.d/10-logging.conf</code> 中的如下三个属性来记录详细调试日志:</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403071127557.png" alt="image-20240307112748022"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403071128215.png" alt="image-20240307112814208"></p><p>从这里可以看到 Dovecot 生成的 SHA512 加密的 <code>zhangsan123456</code> 与数据库中的并不一致</p><blockquote><p>PS: 在前面新建数据库时我们使用了加盐密码, 但是没有存储盐值, 后来我把加盐去掉了, 相应的 zhangsan123456 在 mysql 中的 sha512 就是 <code>$6$b92dcd2db75c3bca</code>, 这里并不能匹配上</p></blockquote><p>需要使用 Dovecot 生成的 SHA512 密码覆盖掉数据库中的密码</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>doveadm pw <span class="token parameter variable">-s</span> SHA512-CRYPT
<span class="token comment"># 输入 zhangsan123456</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403071131663.png" alt="image-20240307113130052"></p><p>将生成的这一整串拷贝下来更新到数据库中</p><div class="language-mysql line-numbers-mode" data-ext="mysql" data-title="mysql"><pre class="language-mysql"><code>UPDATE virtual_users
SET password = &#39;{SHA512-CRYPT}$6$1usGCm9j6RW5vkIe$q86YxTXRI0gFW4elsHmMS8puW1wAs0GEXTyfxVoqxeU/6S2sZYH4no99Pvv9lA1Ka9fvzjha3ogTTD4lq3DZE/&#39;
WHERE email = &#39;zhangsan@ayusummer.com&#39;;
# 相应的
UPDATE virtual_users
SET password = &#39;{SHA512-CRYPT}$6$xSB1atu8NVtHnvEZ$/Ngn354.FuRXXbm1.CZ.OLJkTOlGwezRLfinxGncaInhhKooIYmCgo8IJCo7V6kDCqx36.ETEKjWqQQpCwPg/1&#39;
WHERE email = &#39;lisi@ayusummer.com&#39;;
# 看一眼表
select * from virtual_users;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403071456160.png" alt="image-20240307145619680"></p><p>然后就能连上了</p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403071108966.png" alt="image-20240307110854009"></p><p><img src="http://cdn.ayusummer233.top/DailyNotes/202403071542234.png" alt="image-20240307154231674"></p><p>成功收发邮件</p><hr>`,48);function Aa(xa,Da){const o=p("ExternalLinkIcon"),c=p("Tabs"),r=p("RouteLink");return u(),m("div",null,[h,a("blockquote",null,[a("p",null,[a("a",b,[e("Postfix 主页 --- The Postfix Home Page"),s(o)])])]),k,g,E,a("blockquote",null,[a("p",null,[a("a",y,[e("搭建邮件服务器之使用Postfix收发邮件 - 小枫同学 - 博客园 (cnblogs.com)"),s(o)])]),a("p",null,[a("a",f,[e("【验】Postfix+Dovecot+MySQL搭建邮件服务器_wx63b644a53b596的技术博客_51CTO博客"),s(o)])])]),_,A,x,a("p",null,[e("关于如何制作自签名 SSL 证书可以参考 "),a("a",D,[e("使用 openssl 生成自签名证书)"),s(o)])]),B,N,q,s(c,{id:"192",data:[{id:"ubuntu"}],active:0},{title0:n(({value:l,isActive:t})=>[e("ubuntu")]),tab0:n(({value:l,isActive:t})=>[S,T,L,P,C,R,I]),_:1}),F,M,a("blockquote",null,[a("p",null,[a("a",w,[e("在 MySQL 8.0 中使用 GRANT 或 IDENTIFIED BY 创建用户时出错 | urashita.com urashita.com (urashita.com) --- MySQL 8.0 ではGRANT、IDENTIFIED BYでユーザーを作成するとエラー | urashita.com 浦下.com (ウラシタドットコム)"),s(o)])])]),U,s(c,{id:"278",data:[{id:"MySQL5.7"},{id:"MySQL8.0"}],active:1},{title0:n(({value:l,isActive:t})=>[e("MySQL5.7")]),title1:n(({value:l,isActive:t})=>[e("MySQL8.0")]),tab0:n(({value:l,isActive:t})=>[O,H,Q]),tab1:n(({value:l,isActive:t})=>[$,Y,G,X,z,W,V,K,j,Z]),_:1}),J,s(c,{id:"423",data:[{id:"ubuntu"}],active:0},{title0:n(({value:l,isActive:t})=>[e("ubuntu")]),tab0:n(({value:l,isActive:t})=>[aa,ea,sa,na,la,ta,ia,oa,ca,pa,ra,da,ua]),_:1}),ma,a("p",null,[e("备份一份 "),va,e(" 然后修改其中内容, 将 "),ha,e(" 和 "),ba,e(" 所在的如下两行的注释去掉以允许Postfix通过 "),s(r,{to:"/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E9%92%93%E9%B1%BC/Postfix/%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A.html#submission%E5%92%8CSMTPS"},{default:n(()=>[e("587(submission) 和 465(smtps)")]),_:1}),e(" 端口发送邮件")]),ka,a("ul",null,[a("li",null,[ga,e(": 定义了 LMTP 服务的 "),s(r,{to:"/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E9%92%93%E9%B1%BC/Postfix/%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A.md/#UNIX%E7%9B%91%E5%90%AC%E5%99%A8"},{default:n(()=>[e("UNIX 监听器")]),_:1})]),Ea,ya,fa]),_a])}const qa=d(v,[["render",Aa],["__file","index.html.vue"]]),Sa=JSON.parse('{"path":"/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E9%92%93%E9%B1%BC/Postfix/","title":"Postfix","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"部署","slug":"部署","link":"#部署","children":[{"level":3,"title":"制作 SSL 证书","slug":"制作-ssl-证书","link":"#制作-ssl-证书","children":[]},{"level":3,"title":"安装与配置 MySQL","slug":"安装与配置-mysql","link":"#安装与配置-mysql","children":[]},{"level":3,"title":"安装与配置 Postfix","slug":"安装与配置-postfix","link":"#安装与配置-postfix","children":[]},{"level":3,"title":"安装与配置 Dovecot","slug":"安装与配置-dovecot","link":"#安装与配置-dovecot","children":[]},{"level":3,"title":"测试邮件服务器是否正常","slug":"测试邮件服务器是否正常","link":"#测试邮件服务器是否正常","children":[]}]}],"git":{"createdTime":1710223636000,"updatedTime":1710223636000,"contributors":[{"name":"Ayusummer","email":"ayusummer233@gmail.com","commits":1}]},"readingTime":{"minutes":20.29,"words":6086},"filePathRelative":"网络安全/钓鱼/Postfix/index.md","localizedDate":"2024年3月12日","excerpt":"\\n<ul>\\n<li><a href=\\"#postfix\\">Postfix</a>\\n<ul>\\n<li><a href=\\"#%E9%83%A8%E7%BD%B2\\">部署</a>\\n<ul>\\n<li><a href=\\"#%E5%88%B6%E4%BD%9C-ssl-%E8%AF%81%E4%B9%A6\\">制作 SSL 证书</a></li>\\n<li><a href=\\"#%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE-mysql\\">安装与配置 MySQL</a>\\n<ul>\\n<li><a href=\\"#%E5%AE%89%E8%A3%85-mysql\\">安装 MySQL</a></li>\\n<li><a href=\\"#%E6%96%B0%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8F%8A%E7%94%A8%E6%88%B7\\">新建数据库及用户</a></li>\\n<li><a href=\\"#%E6%96%B0%E5%BB%BA%E8%A1%A8%E6%A0%BC\\">新建表格</a></li>\\n<li><a href=\\"#%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE\\">插入数据</a></li>\\n</ul>\\n</li>\\n<li><a href=\\"#%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE-postfix\\">安装与配置 Postfix</a>\\n<ul>\\n<li><a href=\\"#%E5%AE%89%E8%A3%85-postfix\\">安装 Postfix</a></li>\\n<li><a href=\\"#%E9%85%8D%E7%BD%AEpostfix\\">配置Postfix</a>\\n<ul>\\n<li><a href=\\"#maincf\\">main.cf</a></li>\\n<li><a href=\\"#mysql-virtual-mailbox-domainscf\\">mysql-virtual-mailbox-domains.cf</a></li>\\n<li><a href=\\"#mysql-virtual-mailbox-mapscf\\">mysql-virtual-mailbox-maps.cf</a></li>\\n<li><a href=\\"#mysql-virtual-alias-mapscf\\">mysql-virtual-alias-maps.cf</a></li>\\n<li><a href=\\"#mastercf\\">master.cf</a></li>\\n</ul>\\n</li>\\n</ul>\\n</li>\\n<li><a href=\\"#%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE-dovecot\\">安装与配置 Dovecot</a>\\n<ul>\\n<li><a href=\\"#%E5%AE%89%E8%A3%85dovecot\\">安装Dovecot</a></li>\\n<li><a href=\\"#%E9%85%8D%E7%BD%AE-dovecot\\">配置 Dovecot</a>\\n<ul>\\n<li><a href=\\"#dovecot-%E4%B8%BB%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6---dovecotconf\\">Dovecot 主配置文件 - dovecot.conf</a></li>\\n<li><a href=\\"#%E9%85%8D%E7%BD%AE%E7%A3%81%E7%9B%98%E8%B7%AF%E5%BE%84%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF--10-mailconf\\">配置磁盘路径相关信息 -10-mail.conf</a></li>\\n<li><a href=\\"#%E9%85%8D%E7%BD%AE%E7%94%A8%E6%88%B7%E9%AA%8C%E8%AF%81%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF---10-authconf\\">配置用户验证相关信息 - 10-auth.conf</a></li>\\n<li><a href=\\"#%E9%85%8D%E7%BD%AEsql-type%E9%AA%8C%E8%AF%81%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF---auth-sqlconfext\\">配置SQL-Type验证相关信息 - auth-sql.conf.ext</a></li>\\n<li><a href=\\"#%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF---dovecot-sqlconfext\\">配置数据库连接相关信息 - dovecot-sql.conf.ext</a></li>\\n<li><a href=\\"#%E9%85%8D%E7%BD%AE%E6%9C%AC%E5%9C%B0socket%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF---10-masterconf\\">配置本地socket相关信息 - 10-master.conf</a></li>\\n<li><a href=\\"#%E9%85%8D%E7%BD%AE-ssl-%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF---10-sslconf\\">配置 SSL 相关信息 - 10-ssl.conf</a></li>\\n</ul>\\n</li>\\n</ul>\\n</li>\\n<li><a href=\\"#%E6%B5%8B%E8%AF%95%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%98%AF%E5%90%A6%E6%AD%A3%E5%B8%B8\\">测试邮件服务器是否正常</a></li>\\n</ul>\\n</li>\\n</ul>\\n</li>\\n</ul>"}');export{qa as comp,Sa as data};
